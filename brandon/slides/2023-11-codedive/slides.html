<!DOCTYPE html>

<meta charset="utf-8">
<link rel="stylesheet" href="/css/pygments.css">

<style>
@font-face {
  font-family: 'Gentium 1';
  src: url('/fonts/GentiumPlus-Regular.ttf');
}
@font-face {
  font-family: 'Gentium 1';
  font-style: italic;
  src: url('/fonts/GentiumPlus-Italic.ttf');
}
@font-face {
  font-family: 'Gentium 2';
  src: url('/fonts/gentium-basic-v11-latin-ext_latin-regular.woff');
}
@font-face {
  font-family: Typewriter;
  src: url('/fonts/FiraCode-Bold.woff2');
}
html {
 background-color: #ddd; line-height: 1.2;
 font-size: 48px; font-family: 'Gentium 1', 'Gentium 2';
}
body {margin: 0}
.slide {
 display: table; margin-bottom: 12px; width: 1280px; min-height: 720px;
}
.slide:before {
 position: absolute; left: 0; right: 0; width: 1280px; height: 720px;
 background-color: white; content: " "; z-index: -1;
}
.slide > div {
 display: table-cell; vertical-align: middle; text-align: center;
}
.slide > div > * {text-align: left;}
.slide > div > div.highlight {width: 100%;}
.slide > div > div,
.slide > div > ul,
.slide > div > ol {
 padding-left: 72px; display: inline-block;
}
.slide > div > p {
 text-align: center;
}
.slide > div > img {width: 100%; height: 700px; object-fit: contain}
.slide > div > img.off {display: block; margin-left: auto; margin-right: auto}
pre {
 /* padding-left: 1em; */
 padding-right: 1em;
 /* line-height: 1.1; */
 font-family: Typewriter; font-size: 80%;
 font-variant-ligatures: none;
}
pre .n {color: #625003}
code {
 font-family: Typewriter; font-size: 80%;
}
td {padding-left: 0.6em; padding-right: 0.6em}
strong {color: #882D17}
em {color: #095358}
.timer {margin: 10px}
.emergency {color: white; background-color: red}
@media print{
    @page {
        size: 1280px 720px;
    }
    body.reading-mode {
        background-color: white;
    }
    body > * {
        page-break-after: always;
        font-size: 36pt;
    }
    tt {
        font-size: 28pt;
    }
}
</style>

<p><b>The History of a Science <br>Hidden in Astronomy Code</b> <br> <br>Brandon Rhodes <br>code::dive <br>Wrocław, Poland <br>2023 November 16</p>
<div>

<p>I’ll talk about:</p>
<ol>
<li>Skyfield library</li>
<li>History of astronomy</li>
<li>Software design</li>
</ol>
</div>

<div>

<p>Skyfield</p>
<ul>
<li>Open-source</li>
<li>Python using NumPy</li>
<li>Positional astronomy</li>
</ul>
</div>

<p><strong>Positional astronomy</strong> is the art <br>of generating <em>coordinates</em> <br>for stars and planets</p>
<div>

<p>But positional astronomy is<br> <em>not</em> what most astronomers do!</p>
<p>(Just like most programmers <br>don’t write compilers)</p>
</div>

<div>

<p>Normal astronomers:</p>
<ol>
<li>Get funding</li>
<li>Sign up for observatory time</li>
<li>Then the <em>observatory</em> uses positional<br>astronomy to compute angles<br>and observe the target</li>
</ol>
</div>

<div>

<p>So, astronomy libraries for <em>actual</em> <br>astronomers are mostly ‘science Photoshop’ <br>for the data they get back</p>
<ul>
<li>Image processing</li>
<li>Spectral analysis</li>
<li>Radio signal processing</li>
</ul>
</div>

<p>But Skyfield’s job is <strong>positional astronomy</strong> itself:<br> give it a <em>time</em>, and it will tell you the <em>position</em><br> of a star, a planet, or a satellite</p>
<div>

<p>A <strong>single</strong> position is enough to aim a telescope, <br>and a script that examines a whole <em>series</em> <br>of positions can answer:</p>
<ul>
<li>What time does Sun set this evening?</li>
<li>When is the next New Moon?</li>
<li>What month will Jupiter be brightest?</li>
<li>When will the Space Station pass overhead?</li>
</ul>
</div>

<div>

<p>—all of which can help <br>in planning observations.</p>
<p>And, of course, you can also use <br>coordinates to draw <em>pretty pictures</em></p>
</div>

<img src="neowise_star_chart.png">

<img src="venus_evening_chart.png">

<img src="solar_system.png">

<p>So Skyfield is useful for anyone <br>who wants to use Python to plan <br>their <em>own observations</em></p>
<p>But—how does Skyfield <em>work?</em> <br> <br>It reads NASA tables <br>of <em>x,y,z</em> planet positions then <br>turns those vectors into angles</p>
<div class="highlight"><pre><span></span><span class="c1"># Q: Can you just subtract vectors?</span>

<span class="err">earth_xyz = earth.at(t)</span>
<span class="err">jupiter_xyz = jupiter.at(t)</span>
<span class="err">return jupiter_xyz - earth_xyz</span>

<span class="c1"># </span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Q: Can you just subtract vectors?</span>

<span class="err">earth_xyz = earth.at(t)</span>
<span class="err">jupiter_xyz = jupiter.at(t)</span>
<span class="err">return jupiter_xyz - earth_xyz</span>

<span class="c1"># A: No, it takes more work</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Here’s how to generate a position.</span>

<span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">planet</span><span class="p">):</span>
    <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">earth_velocity</span> <span class="o">=</span> <span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">light_time_correct</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">planet</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">deflect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="p">[</span><span class="n">sun</span><span class="p">,</span> <span class="n">jupiter</span><span class="p">,</span> <span class="n">saturn</span><span class="p">])</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">aberrate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_velocity</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyz_to_coordinates</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># This code includes a short history of astronomy!</span>

<span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">planet</span><span class="p">):</span>
    <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">earth_velocity</span> <span class="o">=</span> <span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">light_time_correct</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">planet</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">deflect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="p">[</span><span class="n">sun</span><span class="p">,</span> <span class="n">jupiter</span><span class="p">,</span> <span class="n">saturn</span><span class="p">])</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">aberrate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_velocity</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyz_to_coordinates</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
</pre></div>

<p>Light-time correction — Ole Rømer (Denmark) 1676 <br> <br>He was observing <strong>Jupiter</strong> <br>over the 13 months between <br>each conjunction with the Sun</p>
<div class="highlight"><pre><span></span><span class="err">                midnight</span>

<span class="err">                   o →</span>


<span class="err">            ↗</span>
<span class="err"> Jupiter  o                 o</span>
<span class="err">                              ↘</span>

<span class="err">─────────────             ─────────────</span>
<span class="err"> morning sky               evening sky</span>
</pre></div>

<p>Rømer’s Observation: Jupiter’s moon <strong>Io</strong> <br>revolves slightly <em>faster</em> in the morning sky <br>than it does in the evening sky! <br> <br>Why would it change speed?</p>
<div>

<p>Hypothesis:</p>
<ul>
<li>Copernicus and Galileo were <strong>right</strong>, the Earth moves</li>
<li>Light <em>takes time to travel</em></li>
<li>The Earth moves <strong>towards</strong> the morning sky</li>
</ul>
</div>

<p>Thus, the light-time delay to Jupiter <br>is getting <strong>shorter</strong> when it’s in the <br>morning sky and <em>longer</em> as it fades <br>into the evening sky <br> <br>Which makes <strong>Io</strong> look faster and slower</p>
<p>‘Light-time correction’ <br> <br>Right now, Jupiter is <strong>33.4 light-minutes</strong> away, <br>so Skyfield needs to use Jupiter’s position from <br><strong>33.4 minutes ago</strong> to generate coordinates</p>
<table>
<tr><td>Light-time correction <td>1676 Ole Rømer
<tr><td>Aberration
<tr><td>Deflection
</table>

<table>
<tr><td>Light-time correction <td>1676 Ole Rømer     <td>40.6″
<tr><td>Aberration
<tr><td>Deflection
</table>

<p>&lt;aside&gt;<br> Units of Measure</p>
<p>Q: <br>If you were going to <em>design</em> a unit of measure, <br>how many units would make a whole?</p>
<p>A: <br>Our ancestors loved numbers with <em>divisors!</em></p>
<div class="highlight"><pre><span></span><span class="err"> 1</span>
<span class="err"> 2</span>
<span class="err"> 3</span>
<span class="err"> 4    2</span>
<span class="err"> 5</span>
<span class="err"> 6    2 3</span>
<span class="err"> 7</span>
<span class="err"> 8    2 4</span>
<span class="err"> 9    3</span>
<span class="err">10    2 5</span>
<span class="err">11</span>
<span class="err">12    2 3 4 6</span>
<span class="err">13</span>
<span class="err"> ⋮   ⋮</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="err"> 1</span>
<span class="err"> 2</span>
<span class="err"> 3</span>
<span class="err"> 4    2         ←</span>
<span class="err"> 5</span>
<span class="err"> 6    2 3       ←</span>
<span class="err"> 7</span>
<span class="err"> 8    2 4</span>
<span class="err"> 9    3</span>
<span class="err">10    2 5</span>
<span class="err">11</span>
<span class="err">12    2 3 4 6   ←</span>
<span class="err">13</span>
<span class="err"> ⋮   ⋮</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="err"> 1</span>
<span class="err"> 2</span>
<span class="err"> 3</span>
<span class="err"> 4    2         ← &quot;highly composite&quot;</span>
<span class="err"> 5</span>
<span class="err"> 6    2 3       ← &quot;highly composite&quot;</span>
<span class="err"> 7</span>
<span class="err"> 8    2 4</span>
<span class="err"> 9    3</span>
<span class="err">10    2 5</span>
<span class="err">11</span>
<span class="err">12    2 3 4 6   ← &quot;highly composite&quot;</span>
<span class="err">13</span>
<span class="err"> ⋮   ⋮</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="err"> 1</span>
<span class="err"> 2</span>
<span class="err"> 3</span>
<span class="err"> 4    2</span>
<span class="err"> 5</span>
<span class="err"> 6    2 3       ← winner all the way to 2×6 = 12</span>
<span class="err"> 7</span>
<span class="err"> 8    2 4</span>
<span class="err"> 9    3</span>
<span class="err">10    2 5</span>
<span class="err">11</span>
<span class="err">12    2 3 4 6   ← winner all the way to 2×12 = 24</span>
<span class="err">13</span>
<span class="err"> ⋮   ⋮</span>
</pre></div>

<p>https://oeis.org/A072938 <br> <br>‘Highly composite numbers that are half <br>of the next highly composite number’</p>
<div class="highlight"><pre><span></span><span class="err">A072938 - A very exclusive club of only 7 numbers</span>

<span class="err">1</span>
<span class="err">2</span>
<span class="err">6</span>
<span class="err">12</span>
<span class="err">60</span>
<span class="err">360</span>
<span class="err">2520</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="err">A072938 - Favorites for units of measure</span>

<span class="err">1</span>
<span class="err">2</span>
<span class="err">6</span>
<span class="err">12</span>
<span class="err">60</span>
<span class="err">360</span>
<span class="err">2520</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="err">A072938</span>

<span class="err">1</span>
<span class="err">2</span>
<span class="err">6</span>
<span class="err">12   Hours of daylight</span>
<span class="err">60</span>
<span class="err">360</span>
<span class="err">2520</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="err">A072938</span>

<span class="err">1</span>
<span class="err">2</span>
<span class="err">6</span>
<span class="err">12   Hours of daylight, Months/year</span>
<span class="err">60</span>
<span class="err">360</span>
<span class="err">2520</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="err">A072938</span>

<span class="err">1</span>
<span class="err">2</span>
<span class="err">6</span>
<span class="err">12   Hours of daylight, Months/year</span>
<span class="err">60</span>
<span class="err">360  Degrees in a circle</span>
<span class="err">2520</span>
</pre></div>

<p>12.37 - 3.0% = 12 <br>365¼ - 1.4% = 360</p>
<p>A <em>question</em> then arose — <br> <br>An hour is pretty long; <br>a degree of sky is pretty big; <br>how should we <strong>divide</strong> them?</p>
<div class="highlight"><pre><span></span><span class="err">1</span>
<span class="err">2</span>
<span class="err">6</span>
<span class="err">12   Hours of daylight, Months/year</span>
<span class="err">60</span>
<span class="err">360  Degrees in a circle</span>
<span class="err">2520</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="err">1</span>
<span class="err">2</span>
<span class="err">6</span>
<span class="err">12   Hours of daylight, Months/year</span>
<span class="err">60   Pars minuta</span>
<span class="err">360  Degrees in a circle</span>
<span class="err">2520</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="err">1</span>
<span class="err">2</span>
<span class="err">6</span>
<span class="err">12   Hours of daylight, Months/year</span>
<span class="err">60   Pars minuta prima, pars minuta secunda</span>
<span class="err">360  Degrees in a circle</span>
<span class="err">2520</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="err">1</span>
<span class="err">2</span>
<span class="err">6</span>
<span class="err">12   Hours of daylight, Months/year</span>
<span class="err">60   ‘Minute’ and ‘second’</span>
<span class="err">360  Degrees in a circle</span>
<span class="err">2520</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="err">1</span>
<span class="err">2</span>
<span class="err">6</span>
<span class="err">12   Hours of daylight, Months/year</span>
<span class="err">60   Pars minuta prima, pars minuta secunda</span>
<span class="err">360  Degrees in a circle</span>
<span class="err">2520</span>
</pre></div>

<p><em>Both</em> times and angles<br> <br> Hours → 60 minutes → 60 seconds<br> Degrees → 60 minutes → 60 seconds <br> <br> </p>
<p>Ambiguity?<br> <br> Hours → 60 minutes → 60 seconds<br> Degrees → 60 minutes → 60 seconds <br> <br> </p>
<p><em>‘arc-’</em><br> <br> Hours → 60 minutes → 60 seconds<br> Degrees → 60 arcminutes → 60 arcseconds <br> <br>12°34′56″</p>
<table>
<tr><td>Width of Moon or Sun<td>0.5°
<tr><td>Naked-eye resolution <td>1–2′
<tr><td>10×50 binoculars <td>10″
<tr><td>Atmospheric blur <td>1–2″
</table>

<p>Binoculars!</p>
<div>

<p>10×50 Binoculars</p>
<ul>
<li>Jupiter’s moons, star clusters</li>
<li>Craters on the Moon, brighter galaxies</li>
<li>Images right-side-up</li>
<li>Uses both eyes</li>
<li>Portable</li>
<li>569 zł</li>
</ul>
</div>

<p><em>NightWatch: A Practical Guide</em> <br><em>to Viewing the Universe</em> <br> <br>by Terence Dickinson</p>
<p>&lt;/aside&gt;</p>
<table>
<tr><td>Light-time correction <td>1676 Ole Rømer     <td>40.6″
<tr><td>Aberration
<tr><td>Deflection
</table>

<table>
<tr><td>Light-time correction <td>1676 Ole Rømer     <td>40.6″
<tr><td>Aberration            <td>1729 James Bradley
<tr><td>Deflection
</table>

<table>
<tr><td>Light-time correction <td>1676 Ole Rømer     <td>40.6″
<tr><td>Aberration            <td>1729 James Bradley <td>20.4″
<tr><td>Deflection
</table>

<table>
<tr><td>Light-time correction <td>1676 Ole Rømer     <td>40.6″
<tr><td>Aberration            <td>1729 James Bradley <td>20.4″
<tr><td>Deflection            <td>1915 Einstein
</table>

<table>
<tr><td>Light-time correction <td>1676 Ole Rømer     <td>40.6″
<tr><td>Aberration            <td>1729 James Bradley <td>20.4″
<tr><td>Deflection            <td>1915 Einstein      <td>1.7″
</table>

<div class="highlight"><pre><span></span><span class="c1"># So, our `get_position()` function</span>
<span class="c1"># is a fun short history of astronomy</span>

<span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">planet</span><span class="p">):</span>
    <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">earth_velocity</span> <span class="o">=</span> <span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">light_time_correct</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">planet</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">deflect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="p">[</span><span class="n">sun</span><span class="p">,</span> <span class="n">jupiter</span><span class="p">,</span> <span class="n">saturn</span><span class="p">])</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">aberrate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_velocity</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyz_to_coordinates</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># But, as code?</span>
<span class="c1"># It’s terrible!</span>

<span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">planet</span><span class="p">):</span>
    <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">earth_velocity</span> <span class="o">=</span> <span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">light_time_correct</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">planet</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">deflect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="p">[</span><span class="n">sun</span><span class="p">,</span> <span class="n">jupiter</span><span class="p">,</span> <span class="n">saturn</span><span class="p">])</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">aberrate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_velocity</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyz_to_coordinates</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
</pre></div>

<p>Q: Why? <br> <br>A: Because it traps us on a<br><strong>Parameter Treadmill</strong></p>
<p>User<br> </p>
<p>User<br>‘How do I ask for astrometric coordinates?’</p>
<div class="highlight"><pre><span></span><span class="c1"># How can we let the user skip aberration and</span>
<span class="c1"># deflection, without breaking existing calls?</span>

<span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">planet</span><span class="p">):</span>
    <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">earth_velocity</span> <span class="o">=</span> <span class="n">earth_at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">light_time_correct</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">planet</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">deflect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="p">[</span><span class="n">sun</span><span class="p">,</span> <span class="n">jupiter</span><span class="p">,</span> <span class="n">saturn</span><span class="p">])</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">aberrate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_velocity</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyz_to_coordinates</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
<span class="c1">#</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Python allows *optional* arguments. Choose</span>
<span class="c1"># a default that keeps the *original* behavior!</span>

<span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">planet</span><span class="p">,</span> <span class="n">apparent</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">earth_velocity</span> <span class="o">=</span> <span class="n">earth_at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">light_time_correct</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">planet</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">apparent</span><span class="p">:</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">deflect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="p">[</span><span class="n">sun</span><span class="p">,</span><span class="n">jupiter</span><span class="p">,</span><span class="n">saturn</span><span class="p">])</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">aberrate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_velocity</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyz_to_coordinates</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
</pre></div>

<p>Another User<br> </p>
<p>Another User<br>‘But I need x,y,z coordinates’</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">planet</span><span class="p">,</span> <span class="n">apparent</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">earth_velocity</span> <span class="o">=</span> <span class="n">earth_at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">light_time_correct</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">planet</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">apparent</span><span class="p">:</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">deflect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="p">[</span><span class="n">sun</span><span class="p">,</span><span class="n">jupiter</span><span class="p">,</span><span class="n">saturn</span><span class="p">])</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">aberrate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_velocity</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyz_to_coordinates</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Let’s add another optional argument.</span>

<span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">planet</span><span class="p">,</span> <span class="n">apparent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">angles</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">earth_velocity</span> <span class="o">=</span> <span class="n">earth_at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">light_time_correct</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">planet</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">apparent</span><span class="p">:</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">deflect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="p">[</span><span class="n">sun</span><span class="p">,</span><span class="n">jupiter</span><span class="p">,</span><span class="n">saturn</span><span class="p">])</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">aberrate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_velocity</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">angles</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xyz</span>
    <span class="k">return</span> <span class="n">xyz_to_coordinates</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
</pre></div>

<p>Yet another user<br> </p>
<p>Yet another user<br>‘I need to adjust the list of deflectors’</p>
<div class="highlight"><pre><span></span><span class="c1">#</span>

<span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">planet</span><span class="p">,</span> <span class="n">apparent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">angles</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">earth_velocity</span> <span class="o">=</span> <span class="n">earth_at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">light_time_correct</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">planet</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">apparent</span><span class="p">:</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">deflect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="p">[</span><span class="n">sun</span><span class="p">,</span><span class="n">jupiter</span><span class="p">,</span><span class="n">saturn</span><span class="p">])</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">aberrate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_velocity</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">angles</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xyz</span>
    <span class="k">return</span> <span class="n">xyz_to_coordinates</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
<span class="c1">#</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Another optional parameter.</span>

<span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">planet</span><span class="p">,</span> <span class="n">apparent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">angles</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">deflectors</span><span class="o">=</span><span class="p">[</span><span class="n">sun</span><span class="p">,</span><span class="n">jupiter</span><span class="p">,</span><span class="n">saturn</span><span class="p">]):</span>
    <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">earth_velocity</span> <span class="o">=</span> <span class="n">earth_at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">light_time_correct</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">planet</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">apparent</span><span class="p">:</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">deflect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">deflectors</span><span class="p">)</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">aberrate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_velocity</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">angles</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xyz</span>
    <span class="k">return</span> <span class="n">xyz_to_coordinates</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
</pre></div>

<p>‘Parameter Treadmill’</p>
<div class="highlight"><pre><span></span><span class="c1"># Eventually:</span>

<span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">planet</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;apparent&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">deflectors</span><span class="o">=</span><span class="p">[</span><span class="n">sun</span><span class="p">,</span> <span class="n">jupiter</span><span class="p">,</span> <span class="n">saturn</span><span class="p">],</span>
        <span class="n">center</span><span class="o">=</span><span class="s1">&#39;Earth&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="s1">&#39;ecliptic&#39;</span><span class="p">,</span>
        <span class="n">lat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">elevation</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="p">):</span>
    <span class="o">...</span>

<span class="c1"># Code becomes littered with `if` statements.</span>
<span class="c1"># Hard to test all possible code paths.</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Python Standard Library itself has functions—</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># —that have obviously gotten caught on the</span>
<span class="c1"># Parameter Treadmill:</span>

<span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">skipkeys</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
           <span class="n">check_circular</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">allow_nan</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
           <span class="bp">cls</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
           <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>

<p>Q: So what’s the alternative <br>to the <strong>Parameter Treadmill?</strong> <br> <br>A: <em>LEGO bricks!</em></p>
<p>LEGO bricks — small interchangeable routines, <br>which the caller assembles into a solution</p>
<div class="highlight"><pre><span></span><span class="c1"># LEGO bricks</span>

<span class="kn">from</span> <span class="nn">astro</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">light_time_correct</span><span class="p">,</span> <span class="n">deflect</span><span class="p">,</span> <span class="n">aberrate</span>
<span class="p">)</span>

<span class="n">earth_xyz</span><span class="p">,</span> <span class="n">earth_velocity</span> <span class="o">=</span> <span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">light_time_correct</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">mars</span><span class="p">)</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">deflect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="p">[</span><span class="n">sun</span><span class="p">,</span> <span class="n">jupiter</span><span class="p">,</span> <span class="n">saturn</span><span class="p">])</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">aberrate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_velocity</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="n">xyz_to_coordinates</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Benefit: user has full control!</span>
<span class="c1">#</span>
<span class="c1"># ‘But I need astrometric coordinates’</span>
<span class="c1"># ‘But I need x,y,z coordinates’</span>
<span class="c1"># ‘I need to adjust the list of deflectors’</span>

<span class="n">earth_xyz</span><span class="p">,</span> <span class="n">earth_velocity</span> <span class="o">=</span> <span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">light_time_correct</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">mars</span><span class="p">)</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">deflect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="p">[</span><span class="n">sun</span><span class="p">,</span> <span class="n">jupiter</span><span class="p">,</span> <span class="n">saturn</span><span class="p">])</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">aberrate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_velocity</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="n">xyz_to_coordinates</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Problems:</span>
<span class="c1">#</span>
<span class="c1">#  • User has to maintain correctness</span>
<span class="c1">#  • Library can’t make improvements</span>
<span class="c1">#  • Wrong level of abstraction: ‘apparent’?</span>

<span class="n">earth_xyz</span><span class="p">,</span> <span class="n">earth_velocity</span> <span class="o">=</span> <span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">light_time_correct</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_xyz</span><span class="p">,</span> <span class="n">mars</span><span class="p">)</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">deflect</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="p">[</span><span class="n">sun</span><span class="p">,</span> <span class="n">jupiter</span><span class="p">,</span> <span class="n">saturn</span><span class="p">])</span>
<span class="n">xyz</span> <span class="o">=</span> <span class="n">aberrate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">earth_velocity</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="n">xyz_to_coordinates</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
</pre></div>

<p>Q: Is there a medium? <br>Parameter Treadmill ← → LEGO bricks <br> <br> </p>
<p>Q: Is there a medium? <br>Parameter Treadmill ← → LEGO bricks <br> <br>A: Method chaining!</p>
<div class="highlight"><pre><span></span><span class="c1"># Method chain</span>


<span class="err">            ┌─ light travel time</span>
<span class="err">            │</span>
<span class="err">            │             ┌─ aberration,deflection</span>
<span class="err">            │             │</span>

<span class="err">earth.at(t).observe(mars).apparent().coordinates()</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Method chain</span>

<span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">mars</span><span class="p">)</span><span class="o">.</span><span class="n">apparent</span><span class="p">()</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>

<span class="c1"># ‘But I need astrometric coordinates’</span>

<span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">mars</span><span class="p">)</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>

<span class="c1"># ‘But I need x,y,z coordinates’</span>

<span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">mars</span><span class="p">)</span><span class="o">.</span><span class="n">xyz</span>
<span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">mars</span><span class="p">)</span><span class="o">.</span><span class="n">apparent</span><span class="p">()</span><span class="o">.</span><span class="n">xyz</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Method chain doesn’t solve everything.</span>

<span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">mars</span><span class="p">)</span><span class="o">.</span><span class="n">apparent</span><span class="p">()</span><span class="o">.</span><span class="n">xyz</span>

<span class="c1"># ‘I need to adjust the list of deflectors’</span>
<span class="c1">#</span>
<span class="c1"># Well, drat, we still might need a parameter</span>

<span class="n">deflectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">sun</span><span class="p">,</span> <span class="n">jupiter</span><span class="p">,</span> <span class="n">saturn</span><span class="p">]</span>
<span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">mars</span><span class="p">)</span><span class="o">.</span><span class="n">apparent</span><span class="p">(</span><span class="n">deflectors</span><span class="p">)</span><span class="o">.</span><span class="n">xyz</span>

<span class="c1"># But only one!</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Method chain</span>

<span class="n">earth</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">mars</span><span class="p">)</span><span class="o">.</span><span class="n">apparent</span><span class="p">()</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>

<span class="c1"># Benefits:</span>
<span class="c1">#  High level of abstraction (‘apparent’)</span>
<span class="c1">#  Makes sure methods are called in right order</span>
<span class="c1">#  Exposes intermediate results</span>
<span class="c1">#  Lets user stop early</span>
</pre></div>

<p>Habit #1: Method chain <br> <br>Parameter Treadmill ←→ LEGO bricks</p>
<p>Habit #2: Configuration objects</p>
<p>The Earth is an <em>oblate spheroid</em> <br> <br>The centrifugal force of our rotation <br>makes Earth’s radius at the equator <strong>larger</strong> <br>than Earth’s radius at the poles</p>
<p>So an <em>x,y,z</em> vector from Earth’s center <br>to a city or observatory on its surface will <br>have a different radius depending on <strong>latitude</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># First version of Skyfield hard-coded</span>
<span class="c1"># the standard WGS84 geoid as the way</span>
<span class="c1"># to turn lat/lon into x,y,z</span>
<span class="c1">#</span>
<span class="c1"># radius = 6378137.0 m</span>
<span class="c1"># flattening = 1/298.257223563</span>

<span class="n">wroc</span> <span class="o">=</span> <span class="n">Place</span><span class="p">(</span><span class="n">lat</span><span class="o">=+</span><span class="mf">51.1079</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mf">17.0385</span><span class="p">)</span>
</pre></div>

<p>User<br> </p>
<p>User <br>‘My data set is older, and uses WGS72’</p>
<div class="highlight"><pre><span></span><span class="n">wroc</span> <span class="o">=</span> <span class="n">Place</span><span class="p">(</span><span class="n">lat</span><span class="o">=+</span><span class="mf">51.1079</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mf">17.0385</span><span class="p">)</span>

<span class="c1"># Drat. WGS84 is currently hard-coded,</span>
<span class="c1"># there’s no way to specify WGS72.</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Worst idea: global configuration</span>

<span class="n">set_geoid_shape</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mf">6378135.0</span><span class="p">,</span>
                <span class="n">flattening</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mf">298.26</span><span class="p">)</span>

<span class="n">wroc</span> <span class="o">=</span> <span class="n">Place</span><span class="p">(</span><span class="n">lat</span><span class="o">=+</span><span class="mf">51.1079</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mf">17.0385</span><span class="p">)</span>

<span class="c1"># Problems:</span>
<span class="c1">#  Invisible action-at-a-distance</span>
<span class="c1">#  Ruins thread safety</span>
<span class="c1">#  Tightly couples tests</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Slightly better: Parameter Treadmill</span>

<span class="n">wroc</span> <span class="o">=</span> <span class="n">Place</span><span class="p">(</span><span class="n">lat</span><span class="o">=+</span><span class="mf">51.1079</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mf">17.0385</span><span class="p">,</span>
             <span class="n">geoid</span><span class="o">=</span><span class="s1">&#39;wgs72&#39;</span><span class="p">)</span>

<span class="c1"># Needs a global registry of geoids</span>

<span class="n">register_earth_geoid</span><span class="p">(</span>
    <span class="s1">&#39;wgs72&#39;</span><span class="p">,</span>
    <span class="n">radius</span><span class="o">=</span><span class="mf">6378135.0</span><span class="p">,</span>
    <span class="n">flattening</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mf">298.26</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Better: instead of accepting a name,</span>
<span class="c1"># accept a Geoid object itself!</span>

<span class="n">wroc</span> <span class="o">=</span> <span class="n">Place</span><span class="p">(</span><span class="n">lat</span><span class="o">=+</span><span class="mf">51.1079</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mf">17.0385</span><span class="p">,</span>
             <span class="n">geoid</span><span class="o">=</span><span class="n">wgs72</span><span class="p">)</span>

<span class="c1"># This lets callers create Geoid objects</span>
<span class="c1"># without needing any global registry:</span>

<span class="n">wgs72</span> <span class="o">=</span> <span class="n">Geoid</span><span class="p">(</span><span class="n">radius_m</span><span class="o">=</span><span class="mf">6378135.0</span><span class="p">,</span>
              <span class="n">flattening</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mf">298.26</span><span class="p">)</span>
</pre></div>

<p>User<br> <br> </p>
<p>User<br>‘What if I already have<br>the x,y,z for a Place?’</p>
<div class="highlight"><pre><span></span><span class="n">wroc</span> <span class="o">=</span> <span class="n">Place</span><span class="p">(</span><span class="n">lat</span><span class="o">=+</span><span class="mf">51.1079</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mf">17.0385</span><span class="p">,</span>
             <span class="n">geoid</span><span class="o">=</span><span class="n">wgs72</span><span class="p">)</span>

<span class="c1"># Then we’re in trouble!  The constructor</span>
<span class="c1"># doesn’t accept x,y,z, but insists on</span>
<span class="c1"># computing x,y,z itself from lat/lon.</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Best: give Place() a simple x,y,z constructor</span>

<span class="n">kraków</span> <span class="o">=</span> <span class="n">Place</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">3856.2</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1399.3</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">4867.4</span><span class="p">)</span>

<span class="c1"># Then, give the Geoid class a method</span>
<span class="c1"># that builds a Place from a lat/lon</span>

<span class="n">wroc</span> <span class="o">=</span> <span class="n">wgs72</span><span class="o">.</span><span class="n">latlon</span><span class="p">(</span><span class="o">+</span><span class="mf">51.1079</span><span class="p">,</span> <span class="mf">17.0385</span><span class="p">)</span>
<span class="n">wroc</span> <span class="o">=</span> <span class="n">wgs84</span><span class="o">.</span><span class="n">latlon</span><span class="p">(</span><span class="o">+</span><span class="mf">51.1079</span><span class="p">,</span> <span class="mf">17.0385</span><span class="p">)</span>

<span class="c1"># The geoid= parameter disappears!</span>
<span class="c1"># We’ve escaped the Parameter Treadmill!</span>
<span class="c1"># Choice of geoid is now always explicit!</span>
</pre></div>

<p>The ‘configuration object’ approach<br> also worked for Earth orientation</p>
<table>
<tr><td>Precession         <td>200 BC Hipparchus <td>46.8°
<tr><td>Nutation           <td>1747 Bradley <td>18.6″
<tr><td>Polar motion xp,yp <td>1884 Chandler <td>0.4″
</table>

<ul>
<li>Precession: long-term formula</li>
<li>Nutation: long-term formula</li>
<li>Polar motion: daily updates!</li>
</ul>
<img src="iers-homepage.png">

<img src="FinalsDataIAU2000A-X_Y_PLAN-BULA.png">

<div class="highlight"><pre><span></span><span class="c1"># A terrible idea would have been</span>
<span class="c1"># to make polar motion global.</span>

<span class="n">load_polar_motion</span><span class="p">(</span><span class="s1">&#39;finals2000A.all&#39;</span><span class="p">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Instead, Skyfield has you build a</span>
<span class="c1"># ‘Timescale’ that loads IERS data and</span>
<span class="c1"># serves as a factory for ‘Time’ objects:</span>

<span class="n">ts</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">timescale</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">utc</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

<span class="c1"># Thus:</span>
<span class="c1">#  No global settings</span>
<span class="c1">#  No invisible action-at-a-distance</span>
<span class="c1">#  No Parameter Treadmill</span>
<span class="c1">#  Multiple ‘Timescale’ objects can coexist</span>
</pre></div>

<p><br>Habit #2: Configuration objects</p>
<p>Habit #3: Healthy Boundaries<br></p>
<p>Example: star chart</p>
<img src="neowise_star_chart.png">

<p>Temptation: give users a <code>star_chart()</code> function!</p>
<img src="neowise_star_chart.png">

<p>User<br> </p>
<p>User<br>‘How do I…’</p>
<p>User<br>‘How do I change the scale?’</p>
<p>User<br>‘How do I change the colors?’</p>
<p>User<br>‘How do I change the font size?’</p>
<p>User<br>‘How do I change how many stars?’</p>
<p>User<br>‘How do I change the date format?’</p>
<p>User<br>‘How do I change the marker color?’</p>
<img src="neowise_star_chart.png">

<div class="highlight"><pre><span></span><span class="c1"># Result? A never-ending Parameter Treadmill</span>

<span class="k">def</span> <span class="nf">star_chart</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">width_degrees</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
               <span class="n">limiting_mag</span><span class="o">=</span><span class="mf">6.5</span><span class="p">,</span> <span class="n">label_fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
               <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">grid_system</span><span class="o">=</span><span class="s1">&#39;ecliptic&#39;</span><span class="p">,</span>
               <span class="n">step_days</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">marker_symbol</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
               <span class="n">marker_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%02d</span><span class="s1">&#39;</span><span class="p">,</span>
               <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">etc</span><span class="o">=...</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>

<p>Solution: <br>I went <strong>full LEGO</strong> <br> <br>Because this isn’t about the relationship <br>between different parts of <em>my</em> library <br> <br>It’s about ‘foreign affairs’ <br>with <em>another</em> library, <strong>matplotlib</strong></p>
<p>So, Skyfield’s docs provide a <strong>full working example</strong> <br>of how to (a) ask Skyfield for coordinates, <br>then (b) go plot the star chart <em>yourself</em></p>
<img src="plot-example-code.png">

<img src="neowise_star_chart.png">

<p>The magic of <em>example code</em> is—</p>
<p>The user can cut-and-paste the example into their <br>own project, then change <em>anything they want</em> <br> </p>
<p>The user can cut-and-paste the example into their <br>own project, then change <em>anything they want</em> <br><strong>without having to ask me</strong></p>
<p>So, whenever possible, <em>avoid</em> getting in the way <br>of a conversation between the user’s code <br>and <strong>another complicated library</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># The philosophy of ‘getting out of the way’</span>
<span class="c1"># even works for simple things like I/O.</span>
<span class="c1">#</span>
<span class="c1"># It’s tempting to do the user a favor</span>
<span class="c1"># by creating an output file for them:</span>

<span class="n">compute_data</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="s1">&#39;table.csv&#39;</span><span class="p">)</span>
</pre></div>

<p>User<br> </p>
<p>User <br>‘But I need to save it to a database, not a file’</p>
<p>User <br>‘But I need to send it over a socket’</p>
<div class="highlight"><pre><span></span><span class="c1"># Those are impossible if we</span>
<span class="c1"># hard-coded the decision that we</span>
<span class="c1"># always write to a file.</span>

<span class="n">compute_data</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="s1">&#39;table.csv&#39;</span><span class="p">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># Instead, leave I/O to the user!</span>
<span class="c1"># Let the user open the file:</span>

<span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;table.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>  <span class="c1"># user</span>

<span class="c1"># Then have them pass the open file to you:</span>

<span class="n">compute_data</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="nb">file</span><span class="p">)</span>         <span class="c1"># your routine</span>
</pre></div>

<p>Accepting a <em>file object</em> argument lets the user <br>swap in another object that writes to <br>a database, a socket, or wherever <br> <br><strong>They</strong> get full control, <br>and <em>you</em> escape the Parameter Treadmill!</p>
<p>Habit #3: Healthy Boundaries <br> <br>Return control <em>as soon as possible</em> <br>and let the <strong>caller</strong> decide what happens next</p>
<div>

<p>Habits</p>
<ol>
<li>Get off the Parameter Treadmill</li>
<li>Store configuration in objects</li>
<li>Set healthy boundaries</li>
<li><span style="opacity:0">On a dark night, try looking at the sky</span></li>
</ol>
<p>  </p>
</div>

<div>

<p>Habits</p>
<ol>
<li>Get off the Parameter Treadmill</li>
<li>Store configuration in objects</li>
<li>Set healthy boundaries</li>
<li>On a dark night, try looking at the sky</li>
</ol>
<p>Thank you! I’m @brandon_rhodes</p>
<!--
TODO Wanting a library to win the least-lines competition
-->

</div>

<script>
(function() {
 var body = document.querySelector('body');
 var a = Array.from(body.children);
 var i = 0;
 a.forEach((item) => {
  i++;
  var html = '<div class=slide><div>' + item.outerHTML + '</div></div>'
  item.outerHTML = html;
 });
 console.log('Slide count:', i);
 console.log('Seconds per slide:', 45 * 60 / i);
})();
</script>

<script src="/js/slides4.js"></script>

