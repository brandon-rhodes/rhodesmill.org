<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.14: http://docutils.sourceforge.net/" />
<title>slides.rst</title>
<link rel="stylesheet" href="/css/slides.css" type="text/css" />
<link rel="stylesheet" href="/css/pygments.css" type="text/css" />
</head>
<body class="reading-mode">
<div class="document">


<div class="section" id="python-linkers-and-virtual-memory">
<h1>Python, Linkers, and Virtual Memory</h1>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
<div class="line">──────────────────</div>
<div class="line"><tt class="docutils literal">PyCon 2012</tt></div>
<div class="line">Brandon Rhodes</div>
<div class="line">──────────────────</div>
</div>
</div>
<div class="section" id="slide">

<div class="line-block">
<div class="line">Imagine a computer</div>
<div class="line">with 1,000 bytes of</div>
<div class="line">addressable RAM</div>
</div>
</div>
<div class="section" id="id1">

<div class="highlight"><pre><span></span><span class="n">Memory</span>     <span class="n">Byte</span>
<span class="n">address</span>   <span class="n">stored</span>

  <span class="mi">999</span>       <span class="mi">128</span>
  <span class="mi">998</span>       <span class="mi">255</span>
  <span class="mi">997</span>       <span class="mi">254</span>
  <span class="mi">996</span>       <span class="mi">128</span>
    <span class="err">·</span>         <span class="err">·</span>
    <span class="err">·</span>         <span class="err">·</span>
    <span class="err">·</span>         <span class="err">·</span>
    <span class="mi">3</span>         <span class="mi">2</span>
    <span class="mi">2</span>         <span class="mi">0</span>
    <span class="mi">1</span>       <span class="mi">104</span>
    <span class="mi">0</span>        <span class="mi">77</span>
</pre></div>

</div>
<div class="section" id="id2">

<div class="line-block">
<div class="line">We split memory into</div>
<div class="line"><em>pages</em> by grouping addresses</div>
<div class="line">that share a common numeric prefix</div>
</div>
</div>
<div class="section" id="id3">

<div class="line-block">
<div class="line">If we defined our</div>
<div class="line"><tt class="docutils literal">page size</tt> = <tt class="docutils literal">100 bytes</tt></div>
</div>
<div class="line-block">
<div class="line">then our <tt class="docutils literal">1,000</tt> bytes of</div>
<div class="line">main memory = <tt class="docutils literal">10 pages</tt></div>
</div>
<div class="line-block">
<div class="line">and <tt class="docutils literal">page 3</tt> would include all</div>
<div class="line">address in the <tt class="docutils literal">3xx</tt> range</div>
</div>
</div>
<div class="section" id="id4">

<div class="highlight"><pre><span></span>   <span class="err">•</span>
  <span class="mi">400</span>
<span class="err">┌─</span><span class="mi">399</span><span class="err">─┐</span>
<span class="err">│</span> <span class="mi">398</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">397</span> <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span>  <span class="err">│</span>
<span class="err">│</span>  <span class="err">•</span>  <span class="err">│</span>   <span class="n">Page</span> <span class="mi">3</span>
<span class="err">│</span>  <span class="err">•</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">302</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">301</span> <span class="err">│</span>
<span class="err">└─</span><span class="mi">300</span><span class="err">─┘</span>
  <span class="mi">299</span>
   <span class="err">•</span>
</pre></div>

</div>
<div class="section" id="what-is-a-page-table">
<h1>What is a page table?</h1>
<div class="highlight"><pre><span></span>   <span class="err">┌─────┐</span>
   <span class="err">│</span> <span class="n">CPU</span> <span class="err">│</span>
   <span class="err">└─────┘</span>
      <span class="err">↕</span>
<span class="err">┌────────────┐</span>
<span class="err">│</span> <span class="n">Page</span> <span class="n">Table</span> <span class="err">│</span>
<span class="err">└────────────┘</span>
      <span class="err">↕</span>
   <span class="err">┌─────┐</span>
   <span class="err">│</span> <span class="n">RAM</span> <span class="err">│</span>
   <span class="err">└─────┘</span>
</pre></div>

</div>
<div class="section" id="id5">

<div class="line-block">
<div class="line"><tt class="docutils literal">rewrites</tt> the leading digits of</div>
<div class="line">every processor memory access <tt class="docutils literal">before</tt></div>
<div class="line">the RAM chip sees the request</div>
</div>
</div>
<div class="section" id="page-table">
<h1>Page Table</h1>
<div class="highlight"><pre><span></span><span class="n">Virtual</span> <span class="n">Physical</span>
<span class="err">┌──────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="err">│</span>
<span class="err">└──────────────┘</span>
</pre></div>

</div>
<div class="section" id="id6">

<p>“Read byte <tt class="docutils literal">821</tt>”  ⇒  “Read byte <tt class="docutils literal">6321</tt>”</p>
<div class="highlight"><pre><span></span>  <span class="err">┌──────────────┐</span>
  <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="err">│</span>
<span class="err">→</span> <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="err">│</span> <span class="err">←</span>
  <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">└──────────────┘</span>
</pre></div>

</div>
<div class="section" id="id7">

<p>“Read byte <tt class="docutils literal">190</tt>”  ⇒  “Read byte <tt class="docutils literal">3690</tt>”</p>
<div class="highlight"><pre><span></span>  <span class="err">┌──────────────┐</span>
  <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">→</span> <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="err">│</span> <span class="err">←</span>
  <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">└──────────────┘</span>
</pre></div>

</div>
<div class="section" id="id8">

<p>“Write byte <tt class="docutils literal">522</tt>”  ⇒  “Write byte <tt class="docutils literal">6022</tt>”</p>
<div class="highlight"><pre><span></span>  <span class="err">┌──────────────┐</span>
  <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="err">│</span>
<span class="err">→</span> <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="err">│</span> <span class="err">←</span>
  <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">└──────────────┘</span>
</pre></div>

</div>
<div class="section" id="id9">

<p>“Read byte <tt class="docutils literal">700</tt>”  ⇒  <tt class="docutils literal">Page fault</tt></p>
<div class="highlight"><pre><span></span>  <span class="err">┌──────────────┐</span>
  <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="err">│</span>
<span class="err">→</span> <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span> <span class="err">←</span>
  <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="err">│</span>
  <span class="err">└──────────────┘</span>
</pre></div>

</div>
<div class="section" id="page-fault">
<h1>Page Fault</h1>
<div class="line-block">
<div class="line">Your program is paused</div>
<div class="line">and the OS regains control</div>
</div>
</div>
<div class="section" id="id10">
<h1>Page Fault</h1>
<div class="line-block">
<div class="line">We will see that the OS</div>
<div class="line">has several ways to respond</div>
</div>
</div>
<div class="section" id="q">
<h1>Q:</h1>
<div class="line-block">
<div class="line">What is stored in the</div>
<div class="line">bytes of memory pages?</div>
</div>
</div>
<div class="section" id="a">
<h1>A:</h1>
<p>Everything your program needs</p>
<ol class="arabic simple">
<li>Executable code</li>
<li>Stack — variables</li>
<li>Heap — data structures</li>
</ol>
</div>
<div class="section" id="id11">

<div class="line-block">
<div class="line">These resources tend to load</div>
<div class="line">gradually as your program runs</div>
</div>
</div>
<div class="section" id="example-running-your-editor">
<h1>Example: Running your editor</h1>
</div>
<div class="section" id="id12">

<p>You say: <em>“Run my editor!”</em></p>
</div>
<div class="section" id="id13">

<div class="line-block">
<div class="line">So the OS loads it into memory</div>
<div class="line">along with any libraries it requires</div>
</div>
</div>
<div class="section" id="example-your-editor">
<h1>Example: Your Editor</h1>
<div class="highlight"><pre><span></span><span class="err">┌──────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="err">│</span> <span class="n">libcurses</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="err">│</span> <span class="n">editor</span> <span class="err">“</span><span class="n">binary</span><span class="err">”</span> <span class="p">(</span><span class="n">program</span><span class="p">)</span>
<span class="err">└──────────────┘</span>
</pre></div>

</div>
<div class="section" id="id14">

<div class="line-block">
<div class="line">The editor's <tt class="docutils literal">main()</tt> function</div>
<div class="line">starts calling other functions</div>
</div>
</div>
<div class="section" id="id15">

<div class="line-block">
<div class="line">So the OS automatically starts</div>
<div class="line">allocating new stack pages</div>
</div>
</div>
<div class="section" id="id16">
<h1>Example: Your Editor</h1>
<div class="highlight"><pre><span></span><span class="err">┌──────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="err">│</span> <span class="n">stack</span> <span class="p">(</span><span class="err">“</span><span class="n">bottom</span><span class="err">”</span> <span class="o">=</span> <span class="n">oldest</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="err">│</span> <span class="n">stack</span> <span class="p">(</span><span class="err">“</span><span class="n">top</span><span class="err">”</span> <span class="o">=</span> <span class="n">newest</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="err">│</span> <span class="n">libcurses</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="err">│</span> <span class="n">editor</span> <span class="err">“</span><span class="n">binary</span><span class="err">”</span> <span class="p">(</span><span class="n">program</span><span class="p">)</span>
<span class="err">└──────────────┘</span>
</pre></div>

</div>
<div class="section" id="id17">

<div class="line-block">
<div class="line">Then the editor needs space</div>
<div class="line">for data structures like</div>
<div class="line">lists and dictionaries</div>
</div>
</div>
<div class="section" id="id18">

<div class="line-block">
<div class="line">So it says <em>“I need more memory!”</em></div>
<div class="line">and the OS says <em>“Okay, have some!”</em></div>
</div>
</div>
<div class="section" id="id19">
<h1>Example: Your Editor</h1>
<div class="highlight"><pre><span></span><span class="err">┌──────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="err">│</span> <span class="n">stack</span> <span class="p">(</span><span class="err">“</span><span class="n">bottom</span><span class="err">”</span> <span class="o">=</span> <span class="n">oldest</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="err">│</span> <span class="n">stack</span> <span class="p">(</span><span class="err">“</span><span class="n">top</span><span class="err">”</span> <span class="o">=</span> <span class="n">newest</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="err">│</span> <span class="n">heap</span> <span class="p">(</span><span class="nb">file</span> <span class="n">being</span> <span class="n">edited</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="err">│</span> <span class="n">heap</span> <span class="p">(</span><span class="n">settings</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>     <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="err">│</span> <span class="n">libcurses</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="err">│</span> <span class="n">editor</span> <span class="err">“</span><span class="n">binary</span><span class="err">”</span> <span class="p">(</span><span class="n">program</span><span class="p">)</span>
<span class="err">└──────────────┘</span>
</pre></div>

</div>
<div class="section" id="id20">
<h1>Page Table</h1>
<div class="line-block">
<div class="line">So what are the benefits</div>
<div class="line">of this level of indirection?</div>
</div>
</div>
<div class="section" id="security">
<h1>Security</h1>
<p>Processes can't see each other's pages</p>
</div>
<div class="section" id="id21">
<h1>Security</h1>
<p>Processes can't see OS pages</p>
</div>
<div class="section" id="id22">
<h1>Security</h1>
<p>The OS wipes reallocated pages with 0s</p>
</div>
<div class="section" id="stability">
<h1>Stability</h1>
<p>Processes can't overwrite each other</p>
</div>
<div class="section" id="id23">
<h1>Stability</h1>
<p>Processes can't crash the OS</p>
</div>
<div class="section" id="id24">

<div class="line-block">
<div class="line">Now, let's add another dimension</div>
<div class="line">of complexity: the idea of <em>protection</em></div>
</div>
</div>
<div class="section" id="protection">
<h1>Protection</h1>
<div class="line-block">
<div class="line">Real page tables include</div>
<div class="line"><em>read</em> and <em>write</em> bits</div>
</div>
</div>
<div class="section" id="id25">

<div class="line-block">
<div class="line">In general you can</div>
</div>
<div class="line-block">
<div class="line"><em>write</em> your own stack and heap</div>
</div>
<div class="line-block">
<div class="line">but only</div>
</div>
<div class="line-block">
<div class="line"><em>read</em> executables</div>
<div class="line">and libraries</div>
</div>
</div>
<div class="section" id="id26">
<h1>Protection</h1>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">heap</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">heap</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libcurses</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">binary</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id27">

<div class="line-block">
<div class="line">If you illegally</div>
<div class="line">read or write—</div>
</div>
</div>
<div class="section" id="id28">

<div class="line-block">
<div class="line">—then instead of responding</div>
<div class="line">to your <em>page fault</em> with</div>
<div class="line">more free memory—</div>
</div>
</div>
<div class="section" id="id29">

<div class="line-block">
<div class="line">—the OS will stop you</div>
<div class="line">with a <em>Segmentation Fault</em></div>
</div>
</div>
<div class="section" id="id30">

<p>“Read from <tt class="docutils literal">331</tt>”</p>
<div class="highlight"><pre><span></span>  <span class="err">┌────────────────┐</span>
  <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">→</span> <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>  <span class="err">→</span> <span class="n">SEGMENTATION</span> <span class="n">FAULT</span>
  <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
  <span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id31">

<p>“Write to <tt class="docutils literal">101</tt>”</p>
<div class="highlight"><pre><span></span>  <span class="err">┌────────────────┐</span>
  <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">→</span> <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="err">→</span> <span class="n">SEGMENTATION</span> <span class="n">FAULT</span>
  <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
  <span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id32">

<div class="line-block">
<div class="line">Read-only pages give the</div>
<div class="line">OS a new superpower:</div>
</div>
<p><strong>Sharing!</strong></p>
</div>
<div class="section" id="sharing">
<h1>Sharing</h1>
<div class="line-block">
<div class="line">Read-only binaries and libraries</div>
<div class="line">can be safely and securely shared</div>
<div class="line">among many processes!</div>
</div>
</div>
<div class="section" id="id33">

<div class="line-block">
<div class="line">These two processes use <em>different</em></div>
<div class="line">pages for heap, stack, and binary</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>         <span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>   <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">48</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>   <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">51</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">heap</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">heap</span>    <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">50</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">heap</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">heap</span>    <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">46</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">heap</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libjson</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libjson</span> <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">48</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libX11</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>    <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>  <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">47</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">firefox</span>
<span class="err">└────────────────┘</span>         <span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id34">

<div class="line-block">
<div class="line">But they safely share a <em>single</em></div>
<div class="line">copy of <tt class="docutils literal">libc</tt> and <tt class="docutils literal">libjson</tt></div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>         <span class="err">┌────────────────┐</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libjson</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libjson</span> <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>    <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">└────────────────┘</span>         <span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id35">

<div class="line-block">
<div class="line">Physical RAM page <tt class="docutils literal">36</tt> can be re-used</div>
<div class="line">for every process needing <tt class="docutils literal">libc</tt></div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>         <span class="err">┌────────────────┐</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libjson</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libjson</span> <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>    <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">└────────────────┘</span>         <span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id36">

<div class="line-block">
<div class="line">And Physical RAM page <tt class="docutils literal">39</tt> can be</div>
<div class="line">re-used for every process needing <tt class="docutils literal">libjson</tt></div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>         <span class="err">┌────────────────┐</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libjson</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libjson</span> <span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>    <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>
<span class="err">│</span>                <span class="err">│</span>         <span class="err">│</span>                <span class="err">│</span>
<span class="err">└────────────────┘</span>         <span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id37">

<div class="line-block">
<div class="line">This means that the total memory</div>
<div class="line">consumed by process A and process B</div>
<div class="line">is <strong>rarely</strong> the sum</div>
</div>
<p><em>(A's memory use) + (B's memory use)</em></p>
</div>
<div class="section" id="id38">
<h1>Q:</h1>
<div class="line-block">
<div class="line">So how can you tell how much memory</div>
<div class="line">an additional worker thread or process</div>
<div class="line">will consume on one of your servers?</div>
</div>
</div>
<div class="section" id="id39">
<h1>A:</h1>
<div class="line-block">
<div class="line">Stop looking at the <em>quantity</em></div>
</div>
<div class="line-block">
<div class="line">“How much RAM does my Python program use?”</div>
</div>
</div>
<div class="section" id="id40">

<div class="line-block">
<div class="line">Start looking at the <em>delta</em></div>
</div>
<p>Δ memory</p>
<div class="line-block">
<div class="line">Ask, “How much memory does each</div>
<div class="line"><em>additional</em> process / worker / thread cost</div>
<div class="line">(and when will that run me out of RAM)?”</div>
</div>
</div>
<div class="section" id="id41">

<div class="line-block">
<div class="line">How should you measure that?</div>
</div>
<div class="line-block">
<div class="line"><em>By actual load and resource tests</em></div>
</div>
<div class="line-block">
<div class="line">Because as we will see,</div>
<div class="line">memory usage is <em>complicated</em></div>
</div>
</div>
<div class="section" id="problem-python-code">
<h1>Problem: Python Code</h1>
</div>
<div class="section" id="id42">

<div class="line-block">
<div class="line"><strong>Q:</strong> Where in virtual memory</div>
<div class="line">does Python code live?</div>
</div>
</div>
<div class="section" id="id43">

<div class="line-block">
<div class="line">Python starts running with</div>
<div class="line">most RAM pages <em>sharable</em></div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id44">

<div class="line-block">
<div class="line">But Python runs <tt class="docutils literal">read()</tt> on <tt class="docutils literal">foo.py</tt> creating</div>
<div class="line">a writable, un-sharable page on the heap</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">foo</span><span class="o">.</span><span class="n">py</span>   <span class="err">←</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id45">

<div class="line-block">
<div class="line">Then Python compiles <tt class="docutils literal">foo.py</tt> to a code</div>
<div class="line">object on <em>another</em> read-write page</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">codeobj</span>  <span class="err">←</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">foo</span><span class="o">.</span><span class="n">py</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id46">

<div class="line-block">
<div class="line">Only <em>then</em> does <tt class="docutils literal">foo.py</tt> start up and</div>
<div class="line">create legitimately unique program data</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">data</span>     <span class="err">←</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">codeobj</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">foo</span><span class="o">.</span><span class="n">py</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id47">

<div class="line-block">
<div class="line">The heap winds up as a mix of actual</div>
<div class="line">unique data, together with shared code</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">data</span>     <span class="err">←</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">codeobj</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">foo</span><span class="o">.</span><span class="n">py</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id48">

<div class="line-block">
<div class="line">Now it just so happens that every</div>
<div class="line">Python X.Y process loading <tt class="docutils literal">foo.py</tt> will</div>
<div class="line">create the exact same code object—</div>
</div>
</div>
<div class="section" id="id49">

<div class="line-block">
<div class="line"><em>—but the OS does not know about this</em></div>
<div class="line">because each Python process builds</div>
<div class="line">its code objects separately</div>
</div>
</div>
<div class="section" id="id50">

<div class="line-block">
<div class="line">To the OS, Python code just looks like heap</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>         <span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>    <span class="err">≠</span>    <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">48</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>    <span class="err">≠</span>    <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">71</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">data</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>    <span class="err">≠</span>    <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">69</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">codeobj</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>    <span class="err">≠</span>    <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">62</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">foo</span><span class="o">.</span><span class="n">py</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>
<span class="err">└────────────────┘</span>         <span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id51">

<p><strong>Q:</strong> Why not share code objects?</p>
</div>
<div class="section" id="id52">

<p><strong>Q:</strong> Why not make them read-only?</p>
</div>
<div class="section" id="id53">

<p><strong>A:</strong> Reference Counts</p>
</div>
<div class="section" id="id54">

<div class="line-block">
<div class="line">Standard <em>C Python</em> does not</div>
<div class="line">support read-only code objects</div>
<div class="line">because it constantly fiddles</div>
<div class="line">with their reference counts</div>
</div>
</div>
<div class="section" id="id55">

<p>What does this code do?</p>
<div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

</div>
<div class="section" id="id56">

<div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

<ol class="arabic simple">
<li>Looks up <tt class="docutils literal">f</tt></li>
<li>Gets back a code object</li>
<li>Increments its reference count</li>
<li>Calls it with <tt class="docutils literal">(5,)</tt></li>
<li>Decrements its reference count</li>
</ol>
</div>
<div class="section" id="why-increment-the-count">
<h1>Why increment the count?</h1>
<div class="line-block">
<div class="line">To prevent other threads</div>
<div class="line">from de-allocating and overwriting</div>
<div class="line"><tt class="docutils literal">f()</tt> while this thread is busy running it</div>
</div>
</div>
<div class="section" id="id57">

<div class="line-block">
<div class="line">Lesson: the OS offers cool optimization</div>
<div class="line">when processes need to <em>share code</em>, but</div>
<div class="line"><em>reference-counted</em> code objects cannot</div>
<div class="line">take advantage of this</div>
</div>
</div>
<div class="section" id="id58">

<p>Now, another basic concept—</p>
</div>
<div class="section" id="dynamic-linking">
<h1>Dynamic Linking</h1>
<div class="line-block">
<div class="line">Take another look</div>
<div class="line">at our Python process</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">heap</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">heap</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libjson</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span><span class="o">.</span><span class="n">so</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id59">
<h1>Dynamic Linking</h1>
<div class="line-block">
<div class="line">The <tt class="docutils literal">python</tt> binary and <tt class="docutils literal">libc.so</tt> library</div>
<div class="line">are separate files sitting on disk</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span><span class="o">.</span><span class="n">so</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id60">
<h1>Dynamic Linking</h1>
<div class="line-block">
<div class="line">How does the Python interpreter find</div>
<div class="line">the routines it needs in <tt class="docutils literal">libc.so</tt>?</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span>                <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span><span class="o">.</span><span class="n">so</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="the-old-days">
<h1>The Old Days</h1>
</div>
<div class="section" id="id61">

<div class="highlight"><pre><span></span><span class="n">prog</span><span class="o">.</span><span class="n">c</span> <span class="err">→</span> <span class="n">prog</span>
</pre></div>

</div>
<div class="section" id="id62">

<p>But then <tt class="docutils literal">prog.c</tt> got really big</p>
</div>
<div class="section" id="id63">

<div class="highlight"><pre><span></span>  <span class="err">“</span><span class="nb">compile</span><span class="err">”</span>  <span class="err">“</span><span class="n">link</span><span class="err">”</span>

<span class="n">cmdn</span><span class="o">.</span><span class="n">c</span> <span class="err">→</span> <span class="n">cmdn</span><span class="o">.</span><span class="n">o</span> <span class="err">↘</span>
<span class="n">opts</span><span class="o">.</span><span class="n">c</span> <span class="err">→</span> <span class="n">opts</span><span class="o">.</span><span class="n">o</span> <span class="err">→</span> <span class="n">prog</span>
<span class="n">slen</span><span class="o">.</span><span class="n">c</span> <span class="err">→</span> <span class="n">slen</span><span class="o">.</span><span class="n">o</span> <span class="err">↗</span>
</pre></div>

</div>
<div class="section" id="id64">

<div class="line-block">
<div class="line">So you only needed to re-compile</div>
<div class="line">the source files you just edited</div>
</div>
</div>
<div class="section" id="id65">
<h1>Q:</h1>
<div class="line-block">
<div class="line">How does the linker</div>
<div class="line">connect the module that calls <tt class="docutils literal">foo()</tt></div>
<div class="line">with the module that defines it?</div>
</div>
<div class="highlight"><pre><span></span>  <span class="err">“</span><span class="nb">compile</span><span class="err">”</span>  <span class="err">“</span><span class="n">link</span><span class="err">”</span>

<span class="n">cmdn</span><span class="o">.</span><span class="n">c</span> <span class="err">→</span> <span class="n">cmdn</span><span class="o">.</span><span class="n">o</span> <span class="err">↘</span>
<span class="n">opts</span><span class="o">.</span><span class="n">c</span> <span class="err">→</span> <span class="n">opts</span><span class="o">.</span><span class="n">o</span> <span class="err">→</span> <span class="n">prog</span>
<span class="n">slen</span><span class="o">.</span><span class="n">c</span> <span class="err">→</span> <span class="n">slen</span><span class="o">.</span><span class="n">o</span> <span class="err">↗</span>
</pre></div>

</div>
<div class="section" id="id66">
<h1>A:</h1>
<div class="line-block">
<div class="line">Every <tt class="docutils literal">.o</tt> file has a table</div>
<div class="line">of names that <em>it</em> defines and names</div>
<div class="line">that it needs <em>someone else</em> to define</div>
</div>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">nm</span> <span class="n">p_move</span><span class="o">.</span><span class="n">o</span>
         <span class="n">U</span> <span class="n">_nc_panelhook</span>
         <span class="n">U</span> <span class="n">is_linetouched</span>
<span class="mo">00000000</span> <span class="n">T</span> <span class="n">move_panel</span>
         <span class="n">U</span> <span class="n">mvwin</span>
         <span class="n">U</span> <span class="n">wtouchln</span>
</pre></div>

</div>
<div class="section" id="id67">

<div class="line-block">
<div class="line">The linker plays <em>matchmaker</em></div>
<div class="line">between names needed</div>
<div class="line">and names provided</div>
</div>
</div>
<div class="section" id="id68">

<div class="line-block">
<div class="line">Linking returns an <tt class="docutils literal">error</tt></div>
<div class="line">if a name needed <em>cannot be found</em></div>
</div>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">ld</span> <span class="o">-</span><span class="n">o</span> <span class="n">prog</span> <span class="n">foo</span><span class="o">.</span><span class="n">o</span> <span class="n">bar</span><span class="o">.</span><span class="n">o</span> <span class="n">baz</span><span class="o">.</span><span class="n">o</span>

<span class="n">foo</span><span class="o">.</span><span class="n">o</span><span class="p">:</span> <span class="n">In</span> <span class="n">function</span> <span class="err">`</span><span class="n">main</span><span class="s1">&#39;:</span>
<span class="n">foo</span><span class="o">.</span><span class="n">c</span><span class="p">:(</span><span class="o">.</span><span class="n">text</span><span class="o">+</span><span class="mh">0x7</span><span class="p">):</span> <span class="n">undefined</span> <span class="n">reference</span> <span class="n">to</span> <span class="err">`</span><span class="n">haute</span><span class="s1">&#39;</span>
<span class="n">collect2</span><span class="p">:</span> <span class="n">ld</span> <span class="n">returned</span> <span class="mi">1</span> <span class="nb">exit</span> <span class="n">status</span>
</pre></div>

</div>
<div class="section" id="id69">

<div class="line-block">
<div class="line">People started sharing useful <tt class="docutils literal">.o</tt></div>
<div class="line">object files with their friends</div>
</div>
</div>
<div class="section" id="id70">

<div class="line-block">
<div class="line">So they used the <tt class="docutils literal">ar</tt> archive tool</div>
<div class="line">to bundle together related <tt class="docutils literal">.o</tt></div>
<div class="line">files into single <tt class="docutils literal">.a</tt> files</div>
</div>
</div>
<div class="section" id="id71">

<div class="line-block">
<div class="line">You can still find <tt class="docutils literal">.a</tt> files</div>
<div class="line">on OS X and Linux today</div>
</div>
</div>
<div class="section" id="id72">

<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">ar</span> <span class="n">t</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libpanel</span><span class="o">.</span><span class="n">a</span>
<span class="n">panel</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_above</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_below</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_bottom</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_delete</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_hide</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_hidden</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_move</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_new</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_replace</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_show</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_top</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_update</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_user</span><span class="o">.</span><span class="n">o</span>
<span class="n">p_win</span><span class="o">.</span><span class="n">o</span>
</pre></div>

</div>
<div class="section" id="id73">

<div class="line-block">
<div class="line">So the linker was given the power</div>
<div class="line">to search an <tt class="docutils literal">.a</tt> archive and link</div>
<div class="line">your program with the extra <tt class="docutils literal">.o</tt></div>
<div class="line">files that it needs</div>
</div>
</div>
<div class="section" id="id74">

<div class="line-block">
<div class="line">The <tt class="docutils literal">.a</tt> file full of <tt class="docutils literal">.o</tt> files</div>
<div class="line">came to be called a <em>“library”</em></div>
</div>
</div>
<div class="section" id="problem">
<h1>Problem:</h1>
<div class="line-block">
<div class="line">If everyone lets the linker</div>
<div class="line">copy <tt class="docutils literal">printf.o</tt> into their program,</div>
<div class="line">then memory has to hold many separate</div>
<div class="line">copies of each popular library</div>
</div>
</div>
<div class="section" id="solution">
<h1>Solution:</h1>
<div class="line-block">
<div class="line">The invention of <tt class="docutils literal">.so</tt></div>
<div class="line"><em>“shared object”</em> files that</div>
<div class="line">can be added to the <strong>page table</strong></div>
<div class="line">of every program that needs them</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span>       <span class="o">.</span>        <span class="err">│</span>
<span class="err">│</span>       <span class="o">.</span>        <span class="err">│</span>
<span class="err">│</span>       <span class="o">.</span>        <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span><span class="o">.</span><span class="n">so</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id75">

<div class="line-block">
<div class="line">The last-minute linking</div>
<div class="line">that takes place at runtime</div>
<div class="line">to connect <tt class="docutils literal">python</tt> to <tt class="docutils literal">libc.so</tt></div>
<div class="line">is called <em>Dynamic Linking</em></div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span>       <span class="o">.</span>        <span class="err">│</span>
<span class="err">│</span>       <span class="o">.</span>        <span class="err">│</span>
<span class="err">│</span>       <span class="o">.</span>        <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span><span class="o">.</span><span class="n">so</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="oddly-enough">
<h1>Oddly enough</h1>
<div class="line-block">
<div class="line">The <tt class="docutils literal">.so</tt> shared library is all</div>
<div class="line">you need to <em>run</em> a program</div>
</div>
<div class="line-block">
<div class="line"><strong>but</strong></div>
</div>
<div class="line-block">
<div class="line">you <em>still</em> need that old-fashioned</div>
<div class="line"><tt class="docutils literal">.a</tt> library to <em>compile</em> the program</div>
</div>
</div>
<div class="section" id="id76">

<div class="line-block">
<div class="line">That's why you need to install <tt class="docutils literal"><span class="pre">libxml2-dev</span></tt></div>
<div class="line">to compile the Python <tt class="docutils literal">lxml</tt> module, even if</div>
</div>
<div class="line-block">
<div class="line"><tt class="docutils literal">/usr/lib/libxml2.so.2.7.8</tt></div>
</div>
<div class="line-block">
<div class="line">already exists on your system</div>
</div>
</div>
<div class="section" id="anyway">
<h1>Anyway</h1>
<div class="line-block">
<div class="line">You can see the libraries that a</div>
<div class="line">program like <tt class="docutils literal">python</tt> needs with <tt class="docutils literal">ldd</tt></div>
</div>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">ldd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mi">7</span>
      <span class="n">linux</span><span class="o">-</span><span class="n">gate</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">1</span>
      <span class="n">libpthread</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">0</span>
      <span class="n">libdl</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">2</span>
      <span class="n">libutil</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">1</span>
      <span class="n">libssl</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">0</span>
      <span class="n">libcrypto</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">0</span>
      <span class="n">libz</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">1</span>
      <span class="n">libm</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">6</span>
      <span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">6</span>
      <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">2</span>
</pre></div>

</div>
<div class="section" id="id77">

<div class="line-block">
<div class="line">You can see the specific names</div>
<div class="line">it needs with <tt class="docutils literal">nm</tt> (“names”)</div>
</div>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">nm</span> <span class="o">-</span><span class="n">D</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mi">7</span>
           <span class="o">.</span>
           <span class="o">.</span>
           <span class="o">.</span>
        <span class="n">U</span> <span class="n">unlink</span>
        <span class="n">U</span> <span class="n">unsetenv</span>
        <span class="n">U</span> <span class="n">utime</span>
        <span class="n">U</span> <span class="n">utimes</span>
        <span class="n">U</span> <span class="n">wait</span>
        <span class="n">U</span> <span class="n">wait3</span>
        <span class="n">U</span> <span class="n">wait4</span>
        <span class="n">U</span> <span class="n">waitpid</span>
        <span class="n">U</span> <span class="n">wcscoll</span>
        <span class="n">U</span> <span class="n">writ</span>
</pre></div>

</div>
<div class="section" id="id78">

<div class="line-block">
<div class="line">Not only is it usual for the</div>
<div class="line">Python <em>binary</em> to be dynamically linked</div>
</div>
<div class="line-block">
<div class="line">but <em>Python extension modules</em></div>
<div class="line">sometimes link against</div>
<div class="line">shared libraries too</div>
</div>
</div>
<div class="section" id="id79">

<div class="line-block">
<div class="line">the <tt class="docutils literal">lxml.etree</tt> Python module</div>
<div class="line">is famous for this</div>
</div>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">ldd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pyshared</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mi">7</span><span class="o">/</span><span class="n">lxml</span><span class="o">/</span><span class="n">etree</span><span class="o">.</span><span class="n">so</span>
       <span class="n">linux</span><span class="o">-</span><span class="n">gate</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">1</span>
       <span class="n">libxslt</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">1</span>
       <span class="n">libexslt</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">0</span>
       <span class="n">libxml2</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">2</span>
       <span class="n">libpthread</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">0</span>
       <span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">6</span>
       <span class="n">libm</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">6</span>
       <span class="n">libgcrypt</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">11</span>
       <span class="n">libdl</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">2</span>
       <span class="n">libz</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">1</span>
       <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">2</span>
       <span class="n">libgpg</span><span class="o">-</span><span class="n">error</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">0</span>
</pre></div>

</div>
<div class="section" id="shared-libraries-cause-problems">
<h1>Shared libraries cause problems</h1>
<div class="line-block">
<div class="line">When a program chooses not to carry a</div>
<div class="line"><em>static copy</em> of every library that it needs,</div>
</div>
<div class="line-block">
<div class="line">there is the danger that a library it</div>
<div class="line">needs will be <em>upgraded</em> or <em>removed</em></div>
</div>
</div>
<div class="section" id="id80">

<div class="line-block">
<div class="line">As an example, let us build:</div>
</div>
<ol class="arabic simple">
<li>a small <em>shared library</em></li>
<li>a <em>Python module</em> that uses it</li>
</ol>
</div>
<div class="section" id="shared-library-libtiny-so">
<h1>Shared library: <tt class="docutils literal">libtiny.so</tt></h1>
</div>
<div class="section" id="id81">

<div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">libtiny</span><span class="o">.</span><span class="n">c</span> <span class="o">*/</span>
<span class="n">helper</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">42</span><span class="p">;</span> <span class="p">}</span>
</pre></div>

<p><tt class="docutils literal">gcc libtiny.c <span class="pre">-shared</span> <span class="pre">-o</span> libtiny.so</tt></p>
</div>
<div class="section" id="python-module-tinymodule-so">
<h1>Python module: <tt class="docutils literal">tinymodule.so</tt></h1>
</div>
<div class="section" id="id82">

<div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">tinymodule</span><span class="o">.</span><span class="n">c</span> <span class="o">*/</span>

<span class="c1">#include &lt;python2.7/Python.h&gt;</span>

<span class="n">static</span> <span class="n">PyMethodDef</span> <span class="n">TinyMethods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span> <span class="n">inittiny</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">helper</span><span class="p">();</span>  <span class="o">/*</span> <span class="n">the</span> <span class="n">call</span> <span class="n">into</span> <span class="n">libtiny</span><span class="o">.</span><span class="n">so</span> <span class="o">*/</span>
    <span class="p">(</span><span class="n">void</span><span class="p">)</span> <span class="n">Py_InitModule</span><span class="p">(</span><span class="s2">&quot;tiny&quot;</span><span class="p">,</span> <span class="n">TinyMethods</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<div class="line-block">
<div class="line"><tt class="docutils literal">gcc tinymodule.c <span class="pre">-L.</span> <span class="pre">-ltiny</span> <span class="pre">-shared</span> \</tt></div>
<div class="line"><tt class="docutils literal"><span class="pre">-o</span> tinymodule.so</tt></div>
</div>
</div>
<div class="section" id="id83">

<div class="line-block">
<div class="line">Having created these two <tt class="docutils literal">*.so</tt> files we</div>
<div class="line">need to add the current directory to</div>
<div class="line">the OS shared library search path</div>
</div>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">export</span> <span class="n">LD_LIBRARY_PATH</span><span class="o">=.</span>
</pre></div>

</div>
<div class="section" id="id84">

<div class="line-block">
<div class="line">So the <em>module</em> <tt class="docutils literal">tinymodule.so</tt></div>
<div class="line">needs the <em>library</em> <tt class="docutils literal">libtiny.so</tt></div>
</div>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">ldd</span> <span class="n">tinymodule</span><span class="o">.</span><span class="n">so</span>
       <span class="n">linux</span><span class="o">-</span><span class="n">gate</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">1</span>
       <span class="n">libtiny</span><span class="o">.</span><span class="n">so</span>
       <span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">6</span>
       <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">2</span>
</pre></div>

</div>
<div class="section" id="shared-library-present-compatible">
<h1>Shared library present, compatible</h1>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">ls</span>
<span class="n">libtiny</span><span class="o">.</span><span class="n">c</span>   <span class="n">tinymodule</span><span class="o">.</span><span class="n">c</span>
<span class="n">libtiny</span><span class="o">.</span><span class="n">so</span>  <span class="n">tinymodule</span><span class="o">.</span><span class="n">so</span>

<span class="err">$</span> <span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;import tiny&#39;</span>

<span class="err">$</span> <span class="n">echo</span> <span class="err">$?</span>
<span class="mi">0</span>
</pre></div>

</div>
<div class="section" id="id85">

<div class="line-block">
<div class="line">What if Python</div>
<div class="line"><em>can</em> find <tt class="docutils literal">tinymodule.so</tt></div>
</div>
<div class="line-block">
<div class="line">but the OS <em>cannot</em> find</div>
<div class="line">its dependency <tt class="docutils literal">libtiny.so</tt>?</div>
</div>
</div>
<div class="section" id="shared-library-missing">
<h1>Shared library missing</h1>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">rm</span> <span class="n">libtiny</span><span class="o">.</span><span class="n">so</span>
<span class="err">$</span> <span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;import tiny&#39;</span>
<span class="ne">ImportError</span><span class="p">:</span> <span class="n">libtiny</span><span class="o">.</span><span class="n">so</span><span class="p">:</span>
    <span class="n">cannot</span> <span class="nb">open</span> <span class="n">shared</span> <span class="nb">object</span> <span class="nb">file</span><span class="p">:</span>
    <span class="n">No</span> <span class="n">such</span> <span class="nb">file</span> <span class="ow">or</span> <span class="n">directory</span>
</pre></div>

</div>
<div class="section" id="incompatible-shared-library">
<h1>Incompatible shared library</h1>
<div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">libtiny</span><span class="o">.</span><span class="n">c</span> <span class="o">*/</span>
<span class="n">different_helper</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">42</span><span class="p">;</span> <span class="p">}</span>
</pre></div>

<p><tt class="docutils literal">gcc libtiny.c <span class="pre">-shared</span> <span class="pre">-o</span> libtiny.so</tt></p>
</div>
<div class="section" id="id86">
<h1>Incompatible shared library</h1>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;import tiny&#39;</span>
<span class="ne">ImportError</span><span class="p">:</span> <span class="o">./</span><span class="n">tinymodule</span><span class="o">.</span><span class="n">so</span><span class="p">:</span>
    <span class="n">undefined</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">helper</span>
</pre></div>

</div>
<div class="section" id="id87">

<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">nm</span> <span class="n">tinymodule</span><span class="o">.</span><span class="n">so</span>
<span class="o">...</span>
<span class="mo">00000354</span> <span class="n">T</span> <span class="n">_init</span>
         <span class="n">U</span> <span class="n">helper</span>
         <span class="mo">0000047</span><span class="n">c</span> <span class="n">T</span> <span class="n">inittiny</span>

<span class="err">$</span> <span class="n">nm</span> <span class="n">libtiny</span><span class="o">.</span><span class="n">so</span>
<span class="o">...</span>
<span class="mo">000002</span><span class="n">f4</span> <span class="n">T</span> <span class="n">_init</span>
<span class="mo">0000041</span><span class="n">c</span> <span class="n">T</span> <span class="n">another_helper</span>
</pre></div>

</div>
<div class="section" id="id88">

<div class="line-block">
<div class="line"><em>“Cannot open shared object”</em></div>
<div class="line">and</div>
<div class="line"><em>“undefined symbol”</em></div>
</div>
<div class="line-block">
<div class="line">are possible because OS tries to</div>
<div class="line">link a binary (<tt class="docutils literal">tinymodule.so</tt>) to</div>
<div class="line">its dependencies (<tt class="docutils literal">libtiny.so</tt>)</div>
<div class="line">at runtime</div>
</div>
</div>
<div class="section" id="id89">

<div class="line-block">
<div class="line">And now, for another puzzle piece:</div>
</div>
</div>
<div class="section" id="demand-paging">
<h1>Demand Paging</h1>
</div>
<div class="section" id="id90">
<h1>Demand Paging</h1>
<div class="line-block">
<div class="line">The OS does not load pages</div>
<div class="line">from disk until your program</div>
<div class="line"><em>reads</em> or <em>writes</em> from them</div>
</div>
</div>
<div class="section" id="id91">

<div class="line-block">
<div class="line">Imagine a program that</div>
<div class="line">has just started running</div>
</div>
</div>
<div class="section" id="id92">

<p>Files:</p>
<div class="line-block">
<div class="line"><tt class="docutils literal">python</tt> — 3 pages</div>
<div class="line"><tt class="docutils literal">libc.so</tt> — 2 pages</div>
</div>
</div>
<div class="section" id="id93">

<div class="line-block">
<div class="line">At first, only one page of</div>
<div class="line">the <tt class="docutils literal">python</tt> binary is loaded</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">heap</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">python</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">python</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span> <span class="err">←</span> <span class="n">LOAD</span> <span class="n">FROM</span> <span class="n">DISK</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id94">

<div class="line-block">
<div class="line">Then Python tries to run the instruction</div>
<div class="line">at <tt class="docutils literal">212</tt> so that page gets loaded too</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">heap</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">37</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span> <span class="err">←</span> <span class="n">LOAD</span> <span class="n">FROM</span> <span class="n">DISK</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">python</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id95">

<div class="line-block">
<div class="line">Then Python calls a function at <tt class="docutils literal">libc</tt></div>
<div class="line">offset <tt class="docutils literal">178</tt> thus <tt class="docutils literal">300 + 178 = 478</tt></div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">heap</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">41</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">libc</span><span class="o">.</span><span class="n">so</span> <span class="err">←</span> <span class="n">LOAD</span> <span class="n">FROM</span> <span class="n">DISK</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">37</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">python</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id96">

<div class="line-block">
<div class="line">If Python keeps calling the same routines,</div>
<div class="line">then only those <tt class="docutils literal">3</tt> pages ever get loaded</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">heap</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">41</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">libc</span><span class="o">.</span><span class="n">so</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">37</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">python</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id97">

<div class="line-block">
<div class="line">So pages are loaded</div>
<div class="line">from disk <em>lazily</em></div>
</div>
</div>
<div class="section" id="id98">

<div class="line-block">
<div class="line">Heap allocation works</div>
<div class="line">the <em>same way</em></div>
</div>
</div>
<div class="section" id="id99">

<div class="line-block">
<div class="line"><strong>Q:</strong> How many RAM pages are allocated if you</div>
<div class="line">ask the OS for three new memory pages?</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">heap</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">41</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">libc</span><span class="o">.</span><span class="n">so</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">python</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id100">

<div class="line-block">
<div class="line"><strong>A:</strong></div>
<div class="line">None!</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">heap</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">41</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">libc</span><span class="o">.</span><span class="n">so</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">python</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id101">

<div class="line-block">
<div class="line">The OS allocates <em>no pages</em> but simply makes</div>
<div class="line">an adjustment to its record-keeping</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>  <span class="err">←</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>  <span class="err">←</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>  <span class="err">←</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">heap</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">41</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">libc</span><span class="o">.</span><span class="n">so</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">python</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id102">

<div class="line-block">
<div class="line">The OS will now respond to page faults</div>
<div class="line">at <tt class="docutils literal">500–799</tt> by allocating a new page,</div>
<div class="line">not raising a <em>Segmentation Fault</em></div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>  <span class="err">←</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>  <span class="err">←</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>  <span class="err">←</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">heap</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">41</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">libc</span><span class="o">.</span><span class="n">so</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">python</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id103">

<div class="line-block">
<div class="line">But no pages are actually allocated until</div>
<div class="line">a <tt class="docutils literal">read</tt> or <tt class="docutils literal">write</tt> shows they are <em>needed</em></div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>  <span class="err">←</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>  <span class="err">←</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>  <span class="err">←</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">heap</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">41</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">libc</span><span class="o">.</span><span class="n">so</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">python</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="that-is-the-difference">
<h1>That is the difference</h1>
<div class="line-block">
<div class="line">between <tt class="docutils literal">VIRT</tt> and <tt class="docutils literal">RES</tt></div>
<div class="line">when you run <tt class="docutils literal">top</tt></div>
</div>
</div>
<div class="section" id="top">
<h1>top</h1>
<div class="highlight"><pre><span></span>               <span class="err">↓</span>     <span class="err">↓</span>

  <span class="n">PID</span> <span class="n">USER</span>    <span class="n">VIRT</span>  <span class="n">RES</span>  <span class="n">SHR</span> <span class="n">S</span> <span class="o">%</span><span class="n">CPU</span> <span class="o">%</span><span class="n">MEM</span> <span class="n">COMMAND</span>
 <span class="mi">1217</span> <span class="n">root</span>    <span class="mi">195</span><span class="n">m</span>  <span class="mi">94</span><span class="n">m</span>  <span class="mi">53</span><span class="n">m</span> <span class="n">S</span>    <span class="mi">2</span>  <span class="mf">2.6</span> <span class="n">Xorg</span>
 <span class="mi">7304</span> <span class="n">brandon</span> <span class="mi">183</span><span class="n">m</span>  <span class="mi">45</span><span class="n">m</span>  <span class="mi">19</span><span class="n">m</span> <span class="n">S</span>    <span class="mi">2</span>  <span class="mf">1.3</span> <span class="n">chromium</span>
 <span class="mi">2027</span> <span class="n">brandon</span> <span class="mi">531</span><span class="n">m</span> <span class="mi">162</span><span class="n">m</span>  <span class="mi">37</span><span class="n">m</span> <span class="n">S</span>    <span class="mi">1</span>  <span class="mf">4.5</span> <span class="n">chromium</span>
 <span class="mi">2319</span> <span class="n">brandon</span> <span class="mi">179</span><span class="n">m</span>  <span class="mi">58</span><span class="n">m</span>  <span class="mi">23</span><span class="n">m</span> <span class="n">S</span>    <span class="mi">1</span>  <span class="mf">1.6</span> <span class="n">chromium</span>
<span class="mi">18841</span> <span class="n">brandon</span> <span class="mi">2820</span> <span class="mi">1188</span>  <span class="mi">864</span> <span class="n">R</span>    <span class="mi">1</span>  <span class="mf">0.0</span> <span class="n">top</span>
 <span class="mi">9776</span> <span class="n">brandon</span> <span class="mi">175</span><span class="n">m</span>  <span class="mi">49</span><span class="n">m</span>  <span class="mi">12</span><span class="n">m</span> <span class="n">S</span>    <span class="mi">0</span>  <span class="mf">1.4</span> <span class="n">chromium</span>

               <span class="err">↑</span>     <span class="err">↑</span>
</pre></div>

</div>
<div class="section" id="id104">

<div class="line-block">
<div class="line"><tt class="docutils literal">VIRT</tt></div>
<div class="line"><em>Virtual Image</em></div>
</div>
<div class="line-block">
<div class="line">All memory pages that promise not</div>
<div class="line">to return a Segmentation Fault</div>
</div>
</div>
<div class="section" id="id105">

<div class="line-block">
<div class="line"><tt class="docutils literal">RES</tt></div>
<div class="line"><em>Resident Size</em></div>
</div>
<div class="line-block">
<div class="line">Only memory pages that have</div>
<div class="line">actually been allocated</div>
</div>
</div>
<div class="section" id="id106">

<div class="line-block">
<div class="line"><tt class="docutils literal">VIRT</tt> — 8 pages</div>
<div class="line"><tt class="docutils literal">RES</tt> — 4 pages</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>         <span class="n">VIRT</span>  <span class="n">RES</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">stack</span>    <span class="err">✓</span>    <span class="err">✓</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>    <span class="err">✓</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>    <span class="err">✓</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">heap</span><span class="p">)</span>    <span class="err">✓</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">heap</span>     <span class="err">✓</span>    <span class="err">✓</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">41</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">libc</span><span class="o">.</span><span class="n">so</span>  <span class="err">✓</span>    <span class="err">✓</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">python</span><span class="p">)</span>  <span class="err">✓</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span>   <span class="err">✓</span>    <span class="err">✓</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id107">

<div class="line-block">
<div class="line"><em>Only</em> <tt class="docutils literal">RES</tt> can actually</div>
<div class="line">run you out of memory</div>
</div>
</div>
<div class="section" id="id108">

<div class="line-block">
<div class="line">Look at <tt class="docutils literal">RES</tt> when you wonder</div>
<div class="line">where all of your RAM is going</div>
</div>
<div class="highlight"><pre><span></span>                     <span class="err">↓</span>

  <span class="n">PID</span> <span class="n">USER</span>    <span class="n">VIRT</span>  <span class="n">RES</span>  <span class="n">SHR</span> <span class="n">S</span> <span class="o">%</span><span class="n">CPU</span> <span class="o">%</span><span class="n">MEM</span> <span class="n">COMMAND</span>
 <span class="mi">1217</span> <span class="n">root</span>    <span class="mi">195</span><span class="n">m</span>  <span class="mi">94</span><span class="n">m</span>  <span class="mi">53</span><span class="n">m</span> <span class="n">S</span>    <span class="mi">2</span>  <span class="mf">2.6</span> <span class="n">Xorg</span>
 <span class="mi">7304</span> <span class="n">brandon</span> <span class="mi">183</span><span class="n">m</span>  <span class="mi">45</span><span class="n">m</span>  <span class="mi">19</span><span class="n">m</span> <span class="n">S</span>    <span class="mi">2</span>  <span class="mf">1.3</span> <span class="n">chromium</span>
 <span class="mi">2027</span> <span class="n">brandon</span> <span class="mi">531</span><span class="n">m</span> <span class="mi">162</span><span class="n">m</span>  <span class="mi">37</span><span class="n">m</span> <span class="n">S</span>    <span class="mi">1</span>  <span class="mf">4.5</span> <span class="n">chromium</span>
 <span class="mi">2319</span> <span class="n">brandon</span> <span class="mi">179</span><span class="n">m</span>  <span class="mi">58</span><span class="n">m</span>  <span class="mi">23</span><span class="n">m</span> <span class="n">S</span>    <span class="mi">1</span>  <span class="mf">1.6</span> <span class="n">chromium</span>
<span class="mi">18841</span> <span class="n">brandon</span> <span class="mi">2820</span> <span class="mi">1188</span>  <span class="mi">864</span> <span class="n">R</span>    <span class="mi">1</span>  <span class="mf">0.0</span> <span class="n">top</span>
 <span class="mi">9776</span> <span class="n">brandon</span> <span class="mi">175</span><span class="n">m</span>  <span class="mi">49</span><span class="n">m</span>  <span class="mi">12</span><span class="n">m</span> <span class="n">S</span>    <span class="mi">0</span>  <span class="mf">1.4</span> <span class="n">chromium</span>

                     <span class="err">↑</span>
</pre></div>

</div>
<div class="section" id="proc-pid-smaps">
<h1>/proc/&lt;pid&gt;/smaps</h1>
<div class="line-block">
<div class="line">Shows whether physical RAM pages</div>
<div class="line">have been allocated to a segment</div>
</div>
</div>
<div class="section" id="id109">

<div class="line-block">
<div class="line">Here are some segments of a new <tt class="docutils literal">python</tt></div>
<div class="line">process sitting quietly at its prompt</div>
</div>
</div>
<div class="section" id="id110">

<div class="highlight"><pre><span></span><span class="mi">08048000</span><span class="o">-</span><span class="mi">08238000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="o">.../</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="n">Size</span><span class="p">:</span>               <span class="mi">1984</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>                 <span class="mi">896</span> <span class="n">kB</span>

<span class="n">b73b9000</span><span class="o">-</span><span class="n">b752f000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="o">.../</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.13</span><span class="o">.</span><span class="n">so</span>
<span class="n">Size</span><span class="p">:</span>               <span class="mi">1496</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>                 <span class="mi">528</span> <span class="n">kB</span>

<span class="n">bfc48000</span><span class="o">-</span><span class="n">bfc69000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="p">[</span><span class="n">stack</span><span class="p">]</span>
<span class="n">Size</span><span class="p">:</span>                <span class="mi">136</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>                 <span class="mi">104</span> <span class="n">kB</span>
</pre></div>

</div>
<div class="section" id="demand-paging-example">
<h1>Demand Paging: Example</h1>
<div class="line-block">
<div class="line">Calling a Python function that</div>
<div class="line">was not called as Python started up</div>
</div>
</div>
<div class="section" id="id111">

<div class="highlight"><pre><span></span><span class="mi">08048000</span><span class="o">-</span><span class="mi">08238000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="o">.../</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="n">Size</span><span class="p">:</span>               <span class="mi">1984</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>                 <span class="mi">896</span> <span class="n">kB</span>
</pre></div>

<p><tt class="docutils literal">&gt;&gt;&gt; frozenset()</tt></p>
<div class="highlight"><pre><span></span><span class="mi">08048000</span><span class="o">-</span><span class="mi">08238000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="o">.../</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="n">Size</span><span class="p">:</span>               <span class="mi">1984</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>                 <span class="mi">916</span> <span class="n">kB</span>
</pre></div>

<p><tt class="docutils literal">916 - 896 = 20</tt> new kilobytes</p>
</div>
<div class="section" id="id112">

<div class="line-block">
<div class="line">So invoking new sections of a binary</div>
<div class="line">or library pulls more pages into RAM</div>
</div>
</div>
<div class="section" id="id113">

<div class="line-block">
<div class="line"><em>But</em> since binary and library</div>
<div class="line">code can always be reloaded from disk,</div>
<div class="line">the OS can also <em>discard</em> those pages</div>
</div>
</div>
<div class="section" id="id114">

<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;range(500000000)&#39;</span>
</pre></div>

<div class="line-block">
<div class="line">This allocates lots of memory</div>
</div>
<div class="line-block">
<div class="line">As it runs, your OS will</div>
<div class="line">dump information overboard to</div>
<div class="line">reclaim every RAM page it can</div>
</div>
</div>
<div class="section" id="id115">

<div class="line-block">
<div class="line">What did this <em>memory hog</em> do</div>
<div class="line">to the other Python process that</div>
<div class="line">was <em>sitting quietly</em> at its prompt?</div>
</div>
</div>
<div class="section" id="id116">

<div class="highlight"><pre><span></span><span class="mi">08048000</span><span class="o">-</span><span class="mi">08238000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="o">.../</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="n">Size</span><span class="p">:</span>               <span class="mi">1984</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>                 <span class="mi">916</span> <span class="n">kB</span>
</pre></div>

<div class="line-block">
<div class="line">↑</div>
<div class="line"><em>before the hog ran</em></div>
<div class="line"><br /></div>
<div class="line"><em>after</em></div>
<div class="line">↓</div>
</div>
<div class="highlight"><pre><span></span><span class="mi">08048000</span><span class="o">-</span><span class="mi">08238000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="o">.../</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="n">Size</span><span class="p">:</span>               <span class="mi">1984</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>                 <span class="mi">464</span> <span class="n">kB</span>
</pre></div>

</div>
<div class="section" id="id117">

<div class="highlight"><pre><span></span><span class="mi">08048000</span><span class="o">-</span><span class="mi">08238000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="o">.../</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="n">Size</span><span class="p">:</span>               <span class="mi">1984</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>                 <span class="mi">916</span> <span class="n">kB</span>
</pre></div>

<div class="line-block">
<div class="line">↑</div>
<div class="line"><br /></div>
<div class="line">Look at the change in <em>Rss</em>!</div>
<div class="line"><br /></div>
<div class="line">↓</div>
</div>
<div class="highlight"><pre><span></span><span class="mi">08048000</span><span class="o">-</span><span class="mi">08238000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="o">.../</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="n">Size</span><span class="p">:</span>               <span class="mi">1984</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>                 <span class="mi">464</span> <span class="n">kB</span>
</pre></div>

</div>
<div class="section" id="id118">

<div class="highlight"><pre><span></span><span class="mi">08048000</span><span class="o">-</span><span class="mi">08238000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="o">.../</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="n">Size</span><span class="p">:</span>               <span class="mi">1984</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>                 <span class="mi">916</span> <span class="n">kB</span>
</pre></div>

<div class="line-block">
<div class="line">↑</div>
<div class="line"><br /></div>
<div class="line"><tt class="docutils literal">916 - 464 = 452k</tt> were thrown overboard!</div>
<div class="line"><br /></div>
<div class="line">↓</div>
</div>
<div class="highlight"><pre><span></span><span class="mi">08048000</span><span class="o">-</span><span class="mi">08238000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="o">.../</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="n">Size</span><span class="p">:</span>               <span class="mi">1984</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>                 <span class="mi">464</span> <span class="n">kB</span>
</pre></div>

</div>
<div class="section" id="id119">

<div class="highlight"><pre><span></span><span class="mi">08048000</span><span class="o">-</span><span class="mi">08238000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="o">.../</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="n">Size</span><span class="p">:</span>               <span class="mi">1984</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>                 <span class="mi">916</span> <span class="n">kB</span>
</pre></div>

<div class="line-block">
<div class="line">↑</div>
<div class="line"><br /></div>
<div class="line">but <tt class="docutils literal">python</tt> will never know, <strong>right?</strong></div>
<div class="line"><br /></div>
<div class="line">↓</div>
</div>
<div class="highlight"><pre><span></span><span class="mi">08048000</span><span class="o">-</span><span class="mi">08238000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="o">.../</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="n">Size</span><span class="p">:</span>               <span class="mi">1984</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>                 <span class="mi">464</span> <span class="n">kB</span>
</pre></div>

</div>
<div class="section" id="right">
<h1>Right!</h1>
<div class="line-block">
<div class="line">Those <tt class="docutils literal">452k</tt> pages will be re-loaded,</div>
<div class="line">on-demand, from disk if this Python</div>
<div class="line">process tries to access them again</div>
</div>
</div>
<div class="section" id="id120">

<p>(well, there is one difference)</p>
</div>
<div class="section" id="id121">

<div class="line-block">
<div class="line">The process will <em>slow down</em> as</div>
<div class="line">de-allocated pages are re-loaded</div>
</div>
</div>
<div class="section" id="id122">

<ul class="simple">
<li><strong>L1 cache</strong> — 3s grabbing a piece of paper</li>
<li><strong>L2 cache</strong> — 14s picking a book from a shelf</li>
<li><strong>System RAM</strong> — 4-minute walk down the hall</li>
<li><strong>Hard drive seek</strong> —</li>
</ul>
<div class="line-block">
<div class="line">“<em>like leaving the building to roam</em></div>
<div class="line"><em>the earth for one year and three months.</em>”</div>
</div>
<blockquote>
— Gustavo Duarte</blockquote>
</div>
<div class="section" id="id123">

<div class="line-block">
<div class="line">That's why your web browser takes</div>
<div class="line">so long to start the first time</div>
</div>
</div>
<div class="section" id="id124">

<p>And now, a Unix superpower!</p>
</div>
<div class="section" id="forking">
<h1>Forking</h1>
</div>
<div class="section" id="id125">

<div class="line-block">
<div class="line">On primitive operating systems the</div>
<div class="line">only way to create a new process</div>
<div class="line">is to start a whole new program</div>
</div>
</div>
<div class="section" id="id126">

<div class="line-block">
<div class="line">The Python interpreter requires</div>
<div class="line">several steps to get going —</div>
</div>
<div class="highlight"><pre><span></span><span class="n">A</span>
<span class="err">↓</span>
<span class="n">B</span>
<span class="err">↓</span>
<span class="n">C</span>
<span class="err">↓</span>
<span class="n">D</span>
</pre></div>

</div>
<div class="section" id="id127">

<div class="line-block">
<div class="line">— then to start a second worker process</div>
<div class="line">you have to send it through the <em>same</em> startup</div>
</div>
<div class="highlight"><pre><span></span><span class="n">Process</span> <span class="mi">1</span>  <span class="n">A</span>
           <span class="err">↓</span>
           <span class="n">B</span>
           <span class="err">↓</span>
           <span class="n">C</span>
           <span class="err">↓</span>
           <span class="n">D</span> <span class="err">—</span> <span class="n">os</span><span class="o">.</span><span class="n">spawn</span><span class="p">()</span> <span class="err">→</span> <span class="n">A</span>  <span class="n">Process</span> <span class="mi">2</span>
           <span class="err">↓</span>                <span class="err">↓</span>
           <span class="o">.</span>                <span class="n">B</span>
           <span class="o">.</span>                <span class="err">↓</span>
           <span class="o">.</span>                <span class="n">C</span>
           <span class="err">↓</span>                <span class="err">↓</span>
           <span class="o">.</span>                <span class="n">D</span>
</pre></div>

</div>
<div class="section" id="id128">

<div class="line-block">
<div class="line">But Linux and OS X support <tt class="docutils literal">fork()</tt>!</div>
</div>
<div class="line-block">
<div class="line"><em>“If you come to a fork</em></div>
<div class="line"><em>in the road, take it!”</em></div>
</div>
</div>
<div class="section" id="id129">

<div class="line-block">
<div class="line"><tt class="docutils literal">fork()</tt> creates a child process that continues</div>
<div class="line">on from the parent's current state</div>
</div>
<div class="highlight"><pre><span></span><span class="n">Process</span> <span class="mi">1</span>  <span class="n">A</span>
           <span class="err">↓</span>
           <span class="n">B</span>
           <span class="err">↓</span>
           <span class="n">C</span>
           <span class="err">↓</span>
           <span class="n">D</span> <span class="err">—</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span> <span class="err">↴</span>  <span class="n">Process</span> <span class="mi">2</span>
           <span class="err">↓</span>             <span class="err">↓</span>
           <span class="n">E</span>             <span class="n">E</span>
           <span class="err">↓</span>             <span class="err">↓</span>
           <span class="n">F</span>             <span class="n">F</span>
           <span class="err">↓</span>             <span class="err">↓</span>
</pre></div>

</div>
<div class="section" id="id130">

<div class="line-block">
<div class="line">The OS <em>could</em> implement <tt class="docutils literal">fork()</tt> naively</div>
<div class="line">by copying every writeable page in the parent</div>
<div class="line">so that the child had its own copy</div>
</div>
<div class="highlight"><pre><span></span>  <span class="n">fork</span><span class="p">()</span> <span class="n">parent</span>              <span class="n">fork</span><span class="p">()</span> <span class="n">child</span>
<span class="err">┌────────────────┐</span>         <span class="err">┌─────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>   <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span> <span class="n">new</span> <span class="n">copy</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">stack</span>   <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span> <span class="n">new</span> <span class="n">copy</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>        <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">heap</span>    <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span> <span class="n">new</span> <span class="n">copy</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">heap</span>    <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span> <span class="n">new</span> <span class="n">copy</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>        <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>        <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libjson</span> <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="p">(</span><span class="n">same</span><span class="p">)</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>    <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="p">(</span><span class="n">same</span><span class="p">)</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>  <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="p">(</span><span class="n">same</span><span class="p">)</span>  <span class="err">│</span>
<span class="err">└────────────────┘</span>         <span class="err">└─────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id131">

<div class="line-block">
<div class="line">But immediately copying every page could</div>
<div class="line">take a <em>long</em> time for a large process,</div>
</div>
<div class="line-block">
<div class="line">and during the copy <em>both</em> parent and</div>
<div class="line">child would be hung waiting!</div>
</div>
</div>
<div class="section" id="id132">

<div class="line-block">
<div class="line">Instead, as you might guess,</div>
<div class="line">the OS implements <tt class="docutils literal">fork()</tt></div>
</div>
<div class="line-block">
<div class="line"><em>lazily,</em></div>
</div>
<div class="line-block">
<div class="line">copying pages on-demand</div>
<div class="line">when the parent or child</div>
<div class="line">performs a write</div>
</div>
</div>
<div class="section" id="id133">

<div class="line-block">
<div class="line">So the OS starts <tt class="docutils literal">fork()</tt> by copying the page</div>
<div class="line">table, marking all pages read-only in <em>both</em></div>
<div class="line">processes, then letting them keep running</div>
</div>
<div class="highlight"><pre><span></span>  <span class="n">fork</span><span class="p">()</span> <span class="n">parent</span>              <span class="n">fork</span><span class="p">()</span> <span class="n">child</span>
<span class="err">┌────────────────┐</span>         <span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">stack</span>   <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">stack</span>   <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">heap</span>    <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">heap</span>    <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>         <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libjson</span> <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="p">(</span><span class="n">same</span><span class="p">)</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>    <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="p">(</span><span class="n">same</span><span class="p">)</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>  <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="p">(</span><span class="n">same</span><span class="p">)</span> <span class="err">│</span>
<span class="err">└────────────────┘</span>         <span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id134">

<div class="line-block">
<div class="line">As writes cause page faults the OS makes copies.</div>
<div class="line">Here page <tt class="docutils literal">63</tt> is copied to <tt class="docutils literal">77</tt> and marked <tt class="docutils literal">w</tt>.</div>
</div>
<div class="highlight"><pre><span></span>    <span class="n">fork</span><span class="p">()</span> <span class="n">parent</span>                 <span class="n">fork</span><span class="p">()</span> <span class="n">child</span>
  <span class="err">┌────────────────┐</span>           <span class="err">┌────────────────┐</span>
  <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>   <span class="n">stack</span>   <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
<span class="err">→</span> <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="err">←</span> <span class="n">stack</span> <span class="err">→</span> <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">77</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="err">←</span>
  <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>           <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>   <span class="n">heap</span>    <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>   <span class="n">heap</span>    <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>           <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>           <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>   <span class="n">libjson</span> <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="p">(</span><span class="n">same</span><span class="p">)</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>   <span class="n">libc</span>    <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="p">(</span><span class="n">same</span><span class="p">)</span> <span class="err">│</span>
  <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>   <span class="n">python</span>  <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="p">(</span><span class="n">same</span><span class="p">)</span> <span class="err">│</span>
  <span class="err">└────────────────┘</span>           <span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id135">

<div class="line-block">
<div class="line"><strong>Q:</strong> How well does this <em>usually</em> work?</div>
</div>
</div>
<div class="section" id="id136">

<div class="line-block">
<div class="line"><strong>A:</strong> It works <em>great!</em></div>
</div>
<div class="line-block">
<div class="line">Only the <em>differences</em> that develop</div>
<div class="line">between the parent and child memory</div>
<div class="line">images incur additional storage</div>
</div>
</div>
<div class="section" id="id137">

<div class="line-block">
<div class="line"><strong>Q:</strong> But how does work for <em>Python</em>?</div>
</div>
</div>
<div class="section" id="id138">

<div class="line-block">
<div class="line"><strong>A:</strong> Terribly!</div>
</div>
</div>
<div class="section" id="id139">

<div class="line-block">
<div class="line">Thanks to reference counts,</div>
<div class="line">merely <em>glancing</em> at data with C Python</div>
<div class="line">forces the OS to create a separate copy</div>
</div>
</div>
<div class="section" id="id140">

<div class="highlight"><pre><span></span><span class="c1"># Create a list</span>

<span class="n">biglist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8460000</span><span class="p">):</span>
    <span class="n">biglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>   <span class="c1"># ~100 MB</span>

<span class="c1"># put fork() here</span>

<span class="c1"># Iterate across the list</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">all</span><span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">biglist</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</pre></div>

</div>
<div class="section" id="c-python">
<h1>C Python</h1>
</div>
<div class="section" id="before-c-python-iterates">
<h1>Before C Python iterates</h1>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="mi">22364</span><span class="o">/</span><span class="n">smaps</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">&#39;/heap/,/Private_D/&#39;</span>
<span class="mi">08</span><span class="n">d60000</span><span class="o">-</span><span class="mi">0</span><span class="n">ef90000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="mi">0</span>     <span class="p">[</span><span class="n">heap</span><span class="p">]</span>
<span class="n">Size</span><span class="p">:</span>             <span class="mi">100544</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>              <span class="mi">100544</span> <span class="n">kB</span>
<span class="n">Pss</span><span class="p">:</span>               <span class="mi">50294</span> <span class="n">kB</span>
<span class="n">Shared_Clean</span><span class="p">:</span>          <span class="mi">0</span> <span class="n">kB</span>
<span class="n">Shared_Dirty</span><span class="p">:</span>     <span class="mi">100500</span> <span class="n">kB</span>
<span class="n">Private_Clean</span><span class="p">:</span>         <span class="mi">0</span> <span class="n">kB</span>
<span class="n">Private_Dirty</span><span class="p">:</span>        <span class="mi">44</span> <span class="n">kB</span>
</pre></div>

</div>
<div class="section" id="after-c-python-iterates">
<h1>After C Python iterates</h1>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="mi">22364</span><span class="o">/</span><span class="n">smaps</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">&#39;/heap/,/Private_D/&#39;</span>
<span class="mi">08</span><span class="n">d60000</span><span class="o">-</span><span class="mi">0</span><span class="n">ef90000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="mi">0</span>     <span class="p">[</span><span class="n">heap</span><span class="p">]</span>
<span class="n">Size</span><span class="p">:</span>             <span class="mi">100544</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>              <span class="mi">100544</span> <span class="n">kB</span>
<span class="n">Pss</span><span class="p">:</span>              <span class="mi">100274</span> <span class="n">kB</span>
<span class="n">Shared_Clean</span><span class="p">:</span>          <span class="mi">0</span> <span class="n">kB</span>
<span class="n">Shared_Dirty</span><span class="p">:</span>        <span class="mi">540</span> <span class="n">kB</span>
<span class="n">Private_Clean</span><span class="p">:</span>         <span class="mi">0</span> <span class="n">kB</span>
<span class="n">Private_Dirty</span><span class="p">:</span>    <span class="mi">100004</span> <span class="n">kB</span>
</pre></div>

</div>
<div class="section" id="id141">
<h1>C Python</h1>
<p>At finish: <strong>0.5%</strong> of heap shared</p>
</div>
<div class="section" id="pypy-2-8">
<h1>PyPy 2.8</h1>
</div>
<div class="section" id="before-pypy-iterates">
<h1>Before PyPy iterates</h1>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="mi">22385</span><span class="o">/</span><span class="n">smaps</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">&#39;/heap/,/Private_D/&#39;</span>
<span class="mi">0</span><span class="n">a5c9000</span><span class="o">-</span><span class="mi">11</span><span class="n">fba000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="mi">0</span>     <span class="p">[</span><span class="n">heap</span><span class="p">]</span>
<span class="n">Size</span><span class="p">:</span>             <span class="mi">124868</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>              <span class="mi">124540</span> <span class="n">kB</span>
<span class="n">Pss</span><span class="p">:</span>               <span class="mi">62274</span> <span class="n">kB</span>
<span class="n">Shared_Clean</span><span class="p">:</span>          <span class="mi">0</span> <span class="n">kB</span>
<span class="n">Shared_Dirty</span><span class="p">:</span>     <span class="mi">124532</span> <span class="n">kB</span>
<span class="n">Private_Clean</span><span class="p">:</span>         <span class="mi">0</span> <span class="n">kB</span>
<span class="n">Private_Dirty</span><span class="p">:</span>         <span class="mi">8</span> <span class="n">kB</span>
</pre></div>

</div>
<div class="section" id="after-pypy-iterates">
<h1>After PyPy iterates</h1>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="mi">22385</span><span class="o">/</span><span class="n">smaps</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">&#39;/heap/,/Private_D/&#39;</span>
<span class="mi">0</span><span class="n">a5c9000</span><span class="o">-</span><span class="mi">11</span><span class="n">fba000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="mi">0</span>     <span class="p">[</span><span class="n">heap</span><span class="p">]</span>
<span class="n">Size</span><span class="p">:</span>             <span class="mi">124868</span> <span class="n">kB</span>
<span class="n">Rss</span><span class="p">:</span>              <span class="mi">124868</span> <span class="n">kB</span>
<span class="n">Pss</span><span class="p">:</span>               <span class="mi">63160</span> <span class="n">kB</span>
<span class="n">Shared_Clean</span><span class="p">:</span>          <span class="mi">0</span> <span class="n">kB</span>
<span class="n">Shared_Dirty</span><span class="p">:</span>     <span class="mi">123416</span> <span class="n">kB</span>
<span class="n">Private_Clean</span><span class="p">:</span>         <span class="mi">0</span> <span class="n">kB</span>
<span class="n">Private_Dirty</span><span class="p">:</span>      <span class="mi">1452</span> <span class="n">kB</span>
</pre></div>

</div>
<div class="section" id="id142">
<h1>PyPy 2.8</h1>
<p>At finish: <strong>96.1%</strong> of heap shared</p>
</div>
<div class="section" id="lesson">
<h1>Lesson:</h1>
<div class="line-block">
<div class="line">Forked worker processes in Unix</div>
<div class="line"><em>share</em> memory when the parent process</div>
<div class="line">builds <em>read-only</em> data structures</div>
</div>
<div class="line-block">
<div class="line">—<em>but</em> not in C Python</div>
</div>
</div>
<div class="section" id="explicitly-sharing-memory">
<h1>Explicitly Sharing Memory</h1>
</div>
<div class="section" id="id143">

<div class="line-block">
<div class="line">How can two Python procedures</div>
<div class="line">share <em>writeable</em> memory</div>
<div class="line">to collaborate?</div>
</div>
<ol class="arabic simple">
<li>Threads</li>
<li>Memory maps</li>
</ol>
</div>
<div class="section" id="threads">
<h1>1. Threads</h1>
</div>
<div class="section" id="id144">

<div class="line-block">
<div class="line">Creating a thread is like <tt class="docutils literal">fork()</tt></div>
<div class="line">except that the heap <em>remains shared</em></div>
<div class="line">between the two threads of control</div>
</div>
</div>
<div class="section" id="id145">

<div class="line-block">
<div class="line">Python supports threads</div>
<div class="line">on both Unix and Windows</div>
</div>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">myfunc</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>

</div>
<div class="section" id="id146">

<div class="line-block">
<div class="line">Each thread gets its <em>own stack</em> so the two</div>
<div class="line">threads can call different functions, but</div>
<div class="line"><em>all other</em> data structures are <em>shared</em></div>
</div>
<div class="highlight"><pre><span></span>    <span class="n">main</span> <span class="n">thread</span>               <span class="n">child</span> <span class="n">thread</span>
<span class="err">┌────────────────┐</span>         <span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">stack</span>  <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">stack</span>  <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">77</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>
<span class="err">└────────────┬───┴─────────┴──┬─────────────┘</span>
             <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
             <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">heap</span>
             <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span> <span class="n">heap</span>
             <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
             <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
             <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libjson</span>
             <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">libc</span>
             <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span> <span class="n">python</span>
             <span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id147">

<div class="line-block">
<div class="line">Since threads</div>
<div class="line">share <em>every</em> data structure</div>
<div class="line">they have to be <em>very</em> careful</div>
</div>
</div>
<div class="section" id="memory-maps">
<h1>2. Memory Maps</h1>
</div>
<div class="section" id="id148">

<div class="line-block">
<div class="line">Using <tt class="docutils literal">mmap()</tt> a parent process</div>
<div class="line">can create shared memory that will be</div>
<div class="line">inherited by all the child workers it forks</div>
</div>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mmap</span><span class="o">,</span> <span class="nn">os</span>

<span class="nb">map</span> <span class="o">=</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
<span class="o">...</span>
</pre></div>

</div>
<div class="section" id="id149">

<div class="highlight"><pre><span></span>  <span class="n">fork</span><span class="p">()</span> <span class="n">parent</span>                 <span class="n">fork</span><span class="p">()</span> <span class="n">child</span>
<span class="err">┌────────────────┐</span>           <span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>   <span class="n">stack</span>   <span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">63</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>   <span class="n">stack</span>   <span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">77</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>
<span class="err">└─────────────┬──┴───────────┴─┬──────────────┘</span>
              <span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">88</span><span class="o">--</span> <span class="o">-</span> <span class="err">│</span> <span class="n">mmap</span> <span class="n">segment</span>
<span class="err">┌─────────────┴──┬───────────┬─┴──────────────┐</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>   <span class="n">heap</span>    <span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>   <span class="n">heap</span>    <span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">60</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>           <span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>           <span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">39</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>   <span class="n">libjson</span> <span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="p">(</span><span class="n">same</span><span class="p">)</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">36</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>   <span class="n">libc</span>    <span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>  <span class="p">(</span><span class="n">same</span><span class="p">)</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>   <span class="n">python</span>  <span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="p">(</span><span class="n">same</span><span class="p">)</span> <span class="err">│</span>
<span class="err">└────────────────┘</span>           <span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id150">

<div class="line-block">
<div class="line">This supports very fast RAM-based</div>
<div class="line">communication between processes</div>
</div>
<div class="line-block">
<div class="line"><em>without</em> requiring</div>
<div class="line">every data structure on the heap</div>
<div class="line">to carry <em>locks</em> or other protection</div>
</div>
</div>
<div class="section" id="another-mmap-capability">
<h1>Another mmap() capability</h1>
</div>
<div class="section" id="id151">

<div class="line-block">
<div class="line">Remember how the OS loads pages</div>
<div class="line">from binary programs like <tt class="docutils literal">python</tt></div>
<div class="line">and shared libraries like <tt class="docutils literal">libc.so</tt></div>
<div class="line">on-demand, not all at once?</div>
</div>
</div>
<div class="section" id="id152">

<div class="line-block">
<div class="line">Well, with <tt class="docutils literal">mmap()</tt> you can do</div>
<div class="line">that yourself, with normal files!</div>
</div>
</div>
<div class="section" id="id153">

<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">mmap(myfile.fileno(),</span> 0)</tt> lets you</div>
<div class="line">replace <tt class="docutils literal">seek()</tt>, <tt class="docutils literal">read()</tt>, and <tt class="docutils literal">write()</tt> calls</div>
<div class="line">and simply access it like an array!</div>
</div>
<div class="highlight"><pre><span></span><span class="err">┌────────────────┐</span>
<span class="err">│</span> <span class="mi">9</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">59</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">stack</span>
<span class="err">│</span> <span class="mi">8</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">7</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">91</span><span class="o">--</span> <span class="o">-</span> <span class="err">│</span>  <span class="n">mmap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="err">↔</span> <span class="n">myfile</span>
<span class="err">│</span> <span class="mi">6</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">90</span><span class="o">--</span> <span class="o">-</span> <span class="err">│</span>  <span class="n">mmap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">↔</span> <span class="n">myfile</span>
<span class="err">│</span> <span class="mi">5</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">61</span><span class="o">--</span> <span class="n">w</span> <span class="err">│</span>  <span class="n">heap</span>
<span class="err">│</span> <span class="mi">3</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">41</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">libc</span><span class="o">.</span><span class="n">so</span>
<span class="err">│</span> <span class="mi">1</span><span class="o">--</span>  <span class="err">→</span>       <span class="o">-</span> <span class="err">│</span> <span class="p">(</span><span class="n">python</span><span class="p">)</span>
<span class="err">│</span> <span class="mi">0</span><span class="o">--</span>  <span class="err">→</span>  <span class="mi">35</span><span class="o">--</span> <span class="n">r</span> <span class="err">│</span>  <span class="n">python</span>
<span class="err">└────────────────┘</span>
</pre></div>

</div>
<div class="section" id="id154">

<p>So, there you have it</p>
</div>
<div class="section" id="id155">

<div class="line-block">
<div class="line">Your processes all access memory</div>
<div class="line">through the mediation of a <em>page table</em></div>
</div>
</div>
<div class="section" id="id156">

<div class="line-block">
<div class="line"><em>Page tables</em> power all</div>
<div class="line">kinds of fun RAM optimizations:</div>
</div>
<ol class="arabic simple">
<li>Demand loading</li>
<li>Shared libraries</li>
<li>Memory maps</li>
<li><tt class="docutils literal">fork()</tt></li>
<li>Threads</li>
</ol>
</div>
<div class="section" id="and">
<h1>And</h1>
<div class="line-block">
<div class="line"><em>PyPy</em> lacks reference counts</div>
<div class="line">which lets the OS <em>do its magic</em></div>
<div class="line">and <em>conserve resources</em></div>
</div>
</div>
<div class="section" id="thank-you">
<h1>Thank you!</h1>
<script>
  window.slide_transition_time = 200;
</script>
<script src="/js/jquery-1.6.2.min.js"></script>
<script src="/js/jquery.url.min.js"></script>
<script src="/js/slides.js"></script></div>
</div>
</body>
</html>
