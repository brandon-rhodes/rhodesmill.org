<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyfield’s Accuracy and Efficiency — Skyfield documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/style.css">
  </head>
  <body>
    
    <p class="motto">
      <b>Skyfield:</b>
      <a href=".">Home</a>
      •
      <a href="toc.html">Table of Contents</a>
      •
      <a href="installation.html#changelog">Changelog</a>
      •
      <a href="api.html">API Reference</a>
    </p>
    
    <div class="section" id="skyfields-accuracy-and-efficiency">
<h1>Skyfield’s Accuracy and Efficiency<a class="headerlink" href="#skyfields-accuracy-and-efficiency" title="Permalink to this headline">¶</a></h1>
<p>This document is a work in progress,
that will be expanded into a full guide.
Right now it covers only one topic.</p>
<div class="section" id="precession-and-nutation">
<h2>Precession and Nutation<a class="headerlink" href="#precession-and-nutation" title="Permalink to this headline">¶</a></h2>
<p>As explained in the section on
<a class="reference internal" href="positions.html#apparent-right-ascension-and-declination"><span class="std std-ref">Apparent right ascension and declination</span></a>,
Skyfield uses the IAU&nbsp;2000A precession-nutation model
to determine the orientation of the Earth’s axes on any given date.
This is used in:</p>
<ul class="simple">
<li>Apparent right ascension and declination
as returned by <a class="reference internal" href="api-position.html#skyfield.positionlib.ICRF.radec" title="skyfield.positionlib.ICRF.radec"><code class="xref py py-meth docutils literal notranslate"><span class="pre">radec()</span></code></a>.</li>
<li>Geographic positions generated by an Earth ellipsoid
like the <a class="reference internal" href="api-topos.html#skyfield.toposlib.wgs84" title="skyfield.toposlib.wgs84"><code class="xref py py-data docutils literal notranslate"><span class="pre">wgs84</span></code></a> model.</li>
<li>The <a class="reference internal" href="api-framelib.html#skyfield.framelib.true_equator_and_equinox_of_date" title="skyfield.framelib.true_equator_and_equinox_of_date"><code class="xref py py-data docutils literal notranslate"><span class="pre">true_equator_and_equinox_of_date</span></code></a>
reference frame that can be used to generate (<em>x,y,z</em>) coordinates
as described in the <a class="reference internal" href="coordinates.html"><span class="doc">Coordinates</span></a> chapter.</li>
<li>The ITRS reference frame
offered through the <a class="reference internal" href="api-framelib.html#skyfield.framelib.itrs" title="skyfield.framelib.itrs"><code class="xref py py-data docutils literal notranslate"><span class="pre">itrs</span></code></a> object,
which combines the orientation of the poles and equinox
with the daily rotation of the Earth.</li>
</ul>
<p>In case you ever need to do low-level math of your own,
each time object offers a matrix <code class="docutils literal notranslate"><span class="pre">t.M</span></code>
that rotates coordinates from the ICRS
into the Earth equatorial coordinate system of that date and time.
See the section on <a class="reference internal" href="coordinates.html#rotation-matrices"><span class="std std-ref">Rotation Matrices</span></a>
for a guide to using a rotation matrix.</p>
</div>
<div class="section" id="polar-motion-1">
<span id="polar-motion"></span><h2>Polar Motion<a class="headerlink" href="#polar-motion-1" title="Permalink to this headline">¶</a></h2>
<p>It was discovered more than a century ago
that the Earth’s crust has a slight freedom
to wobble with respect to the Earth’s axis of rotation in space,
because the continents and ocean basis are bound to the planet’s mass
only through the fluid coupling of our planet’s viscous mantle.
In Skyfield you can see the size of the effect
by loading an official data file
from the International Earth Rotation Service (IERS)
and measuring the maximum excursions
of the polar motion parameters <em>x</em> and <em>y</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skyfield.api</span> <span class="kn">import</span> <span class="n">load</span>
<span class="kn">from</span> <span class="nn">skyfield.data</span> <span class="kn">import</span> <span class="n">iers</span>

<span class="n">url</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">build_url</span><span class="p">(</span><span class="s1">&#39;finals2000A.all&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">load</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">finals_data</span> <span class="o">=</span> <span class="n">iers</span><span class="o">.</span><span class="n">parse_x_y_dut1_from_finals_all</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">ts</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">timescale</span><span class="p">()</span>
<span class="n">iers</span><span class="o">.</span><span class="n">install_polar_motion_table</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">finals_data</span><span class="p">)</span>

<span class="n">tt</span><span class="p">,</span> <span class="n">x_arcseconds</span><span class="p">,</span> <span class="n">y_arcseconds</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">polar_motion_table</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;x:&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x_arcseconds</span><span class="p">)),</span> <span class="s1">&#39;arcseconds&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;y:&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y_arcseconds</span><span class="p">)),</span> <span class="s1">&#39;arcseconds&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>x: 0.32548 arcseconds
y: 0.596732 arcseconds
</pre></div>
</div>
<p>In what kinds of Skyfield calculations
does the exact position of the Earth’s crust come into play?</p>
<p>At the most basic level,
the two polar motion rotations
are applied directly to the ITRS reference frame
in <a class="reference internal" href="api-framelib.html#skyfield.framelib.itrs" title="skyfield.framelib.itrs"><code class="xref py py-data docutils literal notranslate"><span class="pre">skyfield.framelib.itrs</span></code></a>,
supplementing the changes in the Earth’s orientation
that Skyfield was already expecting
thanks to its IAU&nbsp;2000A precession and nutation models.
This, in turn, slightly affects:</p>
<ul class="simple">
<li>The position of an observer on the Earth’s surface.</li>
<li>The relative position of a target with
respect to an observer on the Earth’s surface.</li>
<li>All alt-azimuth coordinates,
since the polar angles <em>x</em> and <em>y</em> tilt the zenith and local horizon
against which altitude and azimuth are measured for a particular observer.</li>
<li>The position of any observation target
that’s located on the Earth’s surface —
for example, if you are calculating the position of a ground station
from the perspective of a space probe.</li>
</ul>
<p>To have Skyfield apply polar motion when computing positions and coordinates,
simply install the IERS tables on your timescale object
as shown in the example code above.
Polar motion will be used everywhere that it applies.</p>
</div>
<div class="section" id="the-leap-second-table-1">
<span id="the-leap-second-table"></span><h2>The leap second table<a class="headerlink" href="#the-leap-second-table-1" title="Permalink to this headline">¶</a></h2>
<p>If you want to double-check that Skyfield’s leap second table
agrees with other tools or software,
you can easily print it out.
Each timescale object offers an array of Julian dates <code class="docutils literal notranslate"><span class="pre">leap_dates</span></code>
and another array of the same length named <code class="docutils literal notranslate"><span class="pre">leap_offsets</span></code>
that offers the difference between UTC and TAI in seconds:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span> <span class="o">=</span> <span class="n">load</span><span class="o">.</span><span class="n">timescale</span><span class="p">()</span>
<span class="k">for</span> <span class="n">jd</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">leap_dates</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">leap_offsets</span><span class="p">):</span>
    <span class="n">ymd</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">tt_jd</span><span class="p">(</span><span class="n">jd</span><span class="p">)</span><span class="o">.</span><span class="n">tt_strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">ymd</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:+}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">offset</span><span class="p">)))</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>2441499.5 1972-07-01 +11
2441683.5 1973-01-01 +12
2442048.5 1974-01-01 +13
...
2456109.5 2012-07-01 +35
2457204.5 2015-07-01 +36
2457754.5 2017-01-01 +37
</pre></div>
</div>
<p>Note that each leap second occurs just before
the Julian date given in the table.
Taking the second row as an example,
the offset between TAI and UTC increased to +12
at the first moment of the day 1973-01-01.
It did so because that day was immediately preceded by a leap second
that was attached to the <em>previous</em> day as its final second.
So the leap second followed the normal, non-leap second 1972-12-31 12:59:59
and had the special designation 1972-12-31 12:59:60.</p>
</div>
<div class="section" id="bad-performance-and-using-100-cpu">
<h2>Bad performance and using 100% CPU<a class="headerlink" href="#bad-performance-and-using-100-cpu" title="Permalink to this headline">¶</a></h2>
<p>On some systems,
users <a class="reference external" href="https://github.com/skyfielders/python-skyfield/issues/595">have reported</a>
that Skyfield consumes 100% of all of their CPUs
and makes it difficult to do other work.</p>
<p>This isn’t something that Skyfield has direct control over.
It’s the underlying NumPy library
that decides how to perform each of the math operations
that Skyfield requests.
And in this case,
the user’s installed version of NumPy
was deciding to run a vector operation in parallel across all the CPUs.
(Ironically, this made the operation slower!)</p>
<p>In case you find NumPy misbehaving in the same way on your system,
the user reported that they were able to force single-threaded behavior
by setting this environment variable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">OPENBLAS_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span>
<span class="n">export</span> <span class="n">MKL_NUM_THREADS</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>If you want to apply these settings right in your Python code,
then you must modify these environment settings
<em>before</em> importing NumPy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># First set up the environment.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OPENBLAS_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MKL_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>

<span class="c1"># And only then import NumPy.</span>

<span class="kn">import</span> <span class="nn">numpy</span>
</pre></div>
</div>
<p>The same solution might work on your system.</p>
</div>
</div>

  </body>
</html>